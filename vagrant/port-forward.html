<!DOCTYPE html>
<html lang="ja">
<head prefix="og: https://ogp.me/ns# fb: https://ogp.me/ns/fb#">
  

  <meta charset="UTF-8">



<!-- Google Search Console -->
<meta name="google-site-verification" content="LhFi5Dhj5KOfXR186QkncucRdBpmVd8B19v-7zcAmlY" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />

  <meta name="description" content="天才星人まくのVagrantノート">

<meta name="keywords" content="Android,Awk,Best Practice,C/C++,CSS,Docker,Fintech,Git,GitHub,Gradle,HTML5,Java,JavaScript,Middleman,MetaTrader,MT4,MT5,Perforce,Python,Ruby,Sed,Shell Script,Vim">

<!-- You can use open graph tags to customize link previews.
Learn more: https://developers.facebook.com/docs/sharing/webmasters -->
<meta property="og:site_name" content="天才まくまくノート" />
<meta property="og:url"     content="https://maku77.github.io/vagrant/port-forward.html" />
<meta property="og:type"    content="website" />
<meta property="og:image"   content="https://maku77.github.io/assets/img/logo-vagrant.png" />

  <meta property="og:description" content="天才星人まくのVagrantノート">

<meta property="fb:app_id"  content="447708168769292" />

<link rel="stylesheet" href="/assets/css/default.css">
<link rel="stylesheet" href="/assets/css/highlight.css">

<!-- Favicons start -->
  <link rel="icon" sizes="16x16 32x32 48x48 64x64" href="/assets/img/favicon/favicon.ico"/>
  <!--[if IE]>
  <link rel="shortcut icon" href="favicon.ico"/>
  <![endif]-->
  <!-- Optional: Android & iPhone -->
  <link rel="apple-touch-icon-precomposed" href="/assets/img/favicon/favicon-152.png"/>
<!-- Favicons end -->

<script src="/assets/js/jquery-3.2.1.min.js"></script>



  <meta property="og:title" content="ポートフォワードにより仮想マシン内のサーバにアクセスする | まくまくVagrantノート" />
  <title>ポートフォワードにより仮想マシン内のサーバにアクセスする - まくまくVagrantノート</title>

  <!-- Ad (Google) -->
  
</head>
<body>

<div class="xPageHeader">
  <a href="/vagrant/">
    <img src="/assets/img/logo-vagrant.svg" class="xPageHeader_logo">
  </a>
  <a href="/vagrant/">
    <div class="xPageHeader_category">
    まくまくVagrantノート
    </div>
  </a>
  <div class="xPageHeader_title">ポートフォワードにより仮想マシン内のサーバにアクセスする</div>
</div>

<div id="xBody">
  

<div class="xBreadCrumbContainer">
  <div class="xBreadCrumb"><a href="/">&#x1F3E0;HOME</a> &gt; <a href="/vagrant/">Vagrant</a></div>
  <div class="xPageDate">2016-10-24</div>
</div>

  
<div style="color:red;">/home/runner/work/maku77.github.io/maku77.github.io<b>/vagrant/port-forward.md</b></div>



  <form action="https://www.google.co.jp/cse" id="cse-search-box">
  <div class="xSearchBar">
    <input type="hidden" name="cx" value="partner-pub-6317852277883092:5930376365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input class="xSearchBar_text" type="search" name="q" placeholder="ノートを検索できます…" size="55" results="5" autocomplete="off" /><input class="xSearchBar_button" type="submit" name="sa" value="&#128269; 検索 " />
  </div>
</form>



  <div id="xContainer">
    <div id="xContainer_main">
      <!-- SNS ボタン（上） -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">




<ul class="xSnsButtons">
  <!-- Twitter -->
  <li class="xSnsButtons_twitter">
    <a rel="nofollow" href="https://twitter.com/share?text=まくまくVagrantノート： ポートフォワードにより仮想マシン内のサーバにアクセスする&url=https://maku77.github.io/vagrant/port-forward.html"
        onclick="window.open(encodeURI(decodeURI(this.href)), 'tweet_window',
        'width=600, height=470, toolbar=no, scrollbars=yes, resizable=yes'); return false;">
      <i class="fa fa-twitter"></i><span class="xSnsButtons_label">ツイート</span>
    </a>
  </li>

  <!-- Facebook -->
  <li class="xSnsButtons_facebook">
    <a rel="nofollow" href="https://www.facebook.com/share.php?u=https://maku77.github.io/vagrant/port-forward.html"
        onclick="window.open(encodeURI(decodeURI(this.href)), 'facebook_window',
        'width=600, height=470, toolbar=no, scrollbars=yes, resizable=yes'); return false;">
      <i class="fa fa-facebook-square"></i><span class="xSnsButtons_label">シェア</span>
    </a>
  </li>

  <!-- Pocket -->
  <li class="xSnsButtons_pocket">
    <a rel="nofollow" href="https://getpocket.com/edit?url=https://maku77.github.io/vagrant/port-forward.html"
        onclick="window.open(encodeURI(decodeURI(this.href)), 'pocket_window',
        'width=600, height=470, toolbar=no, scrollbars=yes, resizable=yes'); return false;">
      <i class="fa fa-get-pocket"></i><span class="xSnsButtons_label">Pocket</span>
    </a>
  </li>
</ul>



      

      <!-- 概要 -->
      

      <div class="xWidget">
        

      </div>

      <div class="xContent">
        <!-- 本文 -->
        <h2 id="ポートフォワードによるネットワーク構成について">ポートフォワードによるネットワーク構成について</h2>

<p>Vagrant 仮想マシン内でサーバを立ち上げた場合、デフォルトではそのポートは仮想マシン内で閉じた世界のものになっています。
例えば、仮想マシン内で Web サーバをポート番号 80 で立ち上げただけでは、外の世界（ホスト側）から <code class="language-plaintext highlighter-rouge">http://localhost/</code> でアクセスできるようにはなりません。
外の世界から仮想マシン内のサーバにアクセスできるようにするための方法として、ポートフォワードがあります（<a href="bridged-network.html">ブリッジネットワークを構成する方法</a>もあります）。</p>

<p>ポートフォワードの設定では、ホストマシンのあるポート番号を、特定の仮想マシンのポート番号にマッピングします。
ホストマシンの特定のポート番号にアクセスがあったときに、ホストマシンが仮想マシンに対してリクエストを転送することで、間接的に仮想マシンへ接続されます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LAN 上のマシン ----[port:10080]----&gt; ホスト ----[port:80]----&gt; 仮想マシン
</code></pre></div></div>

<p>ポートフォワードを利用したネットワーク構成では、既存の物理 LAN 上の別のマシンからは、ホストマシンの IP アドレスしか見えません。
仮想マシンの存在は隠蔽されており、ホストマシンですべてのサービスが提供されているかのように見えます。</p>

<h2 id="ポートフォワードの設定を行う">ポートフォワードの設定を行う</h2>

<p><code class="language-plaintext highlighter-rouge">Vagrantfile</code> ファイルの中で、<code class="language-plaintext highlighter-rouge">config.vm.network</code> に <strong>forwarded_port</strong> を設定することで、ポートフォワードの設定を行うことができます。
下記は、仮想マシン内の HTTP (80) と HTTPS (443) のポートを、ホスト側のポート 10080 と 10443 にそれぞれマッピングする例です。</p>

<h4 id="vagrantfile">Vagrantfile</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s2">"hashicorp/precise64"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">80</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">10080</span>   <span class="c1"># HTTP</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">443</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">10443</span>  <span class="c1"># HTTPS</span>
<span class="k">end</span>
</code></pre></div></div>

<p>設定を変更したら、仮想マシンをリロードして反映させます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vagrant reload
...
==&gt; default: Forwarding ports...
    default: 80 (guest) =&gt; 10080 (host) (adapter 1)
    default: 443 (guest) =&gt; 10443 (host) (adapter 1)
    default: 22 (guest) =&gt; 2222 (host) (adapter 1)
...
</code></pre></div></div>

<p>これで、Web ブラウザなどから <code class="language-plaintext highlighter-rouge">http://localhost:10080/</code> にアクセスしたときに、仮想マシン内の Web サーバの 80 ポートに繋がるようになります（もちろん、仮想マシン側で nginx などの Web サーバを立ち上げておく必要があります）。</p>

<h2 id="ポートフォワードの設定を確認する">ポートフォワードの設定を確認する</h2>

<p>現在動作している仮想マシンのポートフォワード設定は <code class="language-plaintext highlighter-rouge">vagrant port</code> コマンドで確認することができます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vagrant port
The forwarded ports for the machine are listed below. Please note that
these values may differ from values configured in the Vagrantfile if the
provider supports automatic port collision detection and resolution.

    22 (guest) =&gt; 2222 (host)
    80 (guest) =&gt; 10080 (host)
   443 (guest) =&gt; 10443 (host)
</code></pre></div></div>

<p>ポート番号 22 (SSH) はデフォルトでホスト側のポート 2222 にマッピングされています（これによって <code class="language-plaintext highlighter-rouge">ssh vagrant@127.0.0.1 -p 2222</code> という接続が可能になっています）。</p>

<h2 id="udp-トラフィックのフォワード">UDP トラフィックのフォワード</h2>

<p><code class="language-plaintext highlighter-rouge">config.vm.network "forwarded_port"</code> のデフォルトの設定では、TCP プロトコルによるフォワード設定しか行われません。
UDP プロトコルのパケットも仮想マシンにフォワードしたい場合は、明示的に <code class="language-plaintext highlighter-rouge">protocol: "udp"</code> オプションを指定して設定する必要があります。</p>

<h4 id="vagrantfile-1">Vagrantfile</h4>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s2">"hashicorp/precise64"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">2003</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">12003</span><span class="p">,</span> <span class="ss">protocol: </span><span class="s2">"tcp"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">2003</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">12003</span><span class="p">,</span> <span class="ss">protocol: </span><span class="s2">"udp"</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="ポート番号のコンフリクトの自動解決">ポート番号のコンフリクトの自動解決</h2>

<p>ポートフォワード設定を行って Vagrant の仮想マシンを立ち上げようとしたときに、ホスト側のポート番号がすでに使用されていてコンフリクトした場合、仮想マシンの立ち上げは失敗します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vagrant reload
...
Vagrant cannot forward the specified ports on this VM, since they
would collide with some other application that is already listening
on these ports. The forwarded port to 8080 is already in use
on the host machine.
...
</code></pre></div></div>

<p>下記のように、<strong>auto_correct</strong> オプションを設定しておくと、ポート番号がコンフリクトした場合に、ホスト側で空いているポートを探して自動的にマッピングすることができます。</p>

<h4 id="vagrantfile-2">Vagrantfile</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s2">"hashicorp/precise64"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">80</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">8080</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>仮想マシンを立ち上げると、自動的にポート番号が割り当てられます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vagrant up
==&gt; default: Checking if box 'hashicorp/precise64' is up to date...
==&gt; default: Fixed port collision for 80 =&gt; 8080. Now on port 2200.
==&gt; default: Clearing any previously set network interfaces...
==&gt; default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
==&gt; default: Forwarding ports...
    default: 80 (guest) =&gt; 2200 (host) (adapter 1)
    default: 22 (guest) =&gt; 2222 (host) (adapter 1)
...
</code></pre></div></div>

<p>ここでは、ホスト側のポート 8080 が開いていなかったため、自動的に 2200 が割り当てられています。
この自動割り当ての範囲は、デフォルトで 2200 から 2250 になっていますが、下記のように調整することもできます。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">usable_port_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span><span class="o">..</span><span class="mi">10050</span><span class="p">)</span>
</code></pre></div></div>


      </div>

      <!-- Ad (楽天) -->
      

      <!-- SNS ボタン（下） -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">




<ul class="xSnsButtons">
  <!-- Twitter -->
  <li class="xSnsButtons_twitter">
    <a rel="nofollow" href="https://twitter.com/share?text=まくまくVagrantノート： ポートフォワードにより仮想マシン内のサーバにアクセスする&url=https://maku77.github.io/vagrant/port-forward.html"
        onclick="window.open(encodeURI(decodeURI(this.href)), 'tweet_window',
        'width=600, height=470, toolbar=no, scrollbars=yes, resizable=yes'); return false;">
      <i class="fa fa-twitter"></i><span class="xSnsButtons_label">ツイート</span>
    </a>
  </li>

  <!-- Facebook -->
  <li class="xSnsButtons_facebook">
    <a rel="nofollow" href="https://www.facebook.com/share.php?u=https://maku77.github.io/vagrant/port-forward.html"
        onclick="window.open(encodeURI(decodeURI(this.href)), 'facebook_window',
        'width=600, height=470, toolbar=no, scrollbars=yes, resizable=yes'); return false;">
      <i class="fa fa-facebook-square"></i><span class="xSnsButtons_label">シェア</span>
    </a>
  </li>

  <!-- Pocket -->
  <li class="xSnsButtons_pocket">
    <a rel="nofollow" href="https://getpocket.com/edit?url=https://maku77.github.io/vagrant/port-forward.html"
        onclick="window.open(encodeURI(decodeURI(this.href)), 'pocket_window',
        'width=600, height=470, toolbar=no, scrollbars=yes, resizable=yes'); return false;">
      <i class="fa fa-get-pocket"></i><span class="xSnsButtons_label">Pocket</span>
    </a>
  </li>
</ul>



      
      <div class="xArticle_up">
        <a href="/vagrant/"><span class="xArticle_up_label">まくまくVagrantノート</span><br>へ戻る</a>
      </div>

    </div>

    <div id="xContainer_sidebar"><style>
.local-logo {
  position: relative;
  border: none;
  background: none;
}
.local-logo img {
  width: 100%;
  vertical-align: bottom;
  border: none;
  border-radius: 15px;
}
.local-logo figcaption {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  text-align: center;
  font-size: 12pt;
  color: white;
  background: rgba(0, 0, 0, 0.7);
  border-radius: 15px 15px 0 0;
}
</style>

<div id="xContainer_sidebar_notFixed">
  <div data-sticky><nav class="xNav">
  <div class="xNav_header">カテゴリ一覧</div>
  <ul>
        <li><a href="/memo/">いろいろ</a>
        <li><a href="/android/">Android</a>
        <li><a href="/ansible/">Ansible</a>
        <li><a href="/blender/">Blender</a>
        <li><a href="/cpp/">C/C++</a>
        <li><a href="/docker/">Docker</a>
        <li><a href="/git/">Git</a>
        <li><a href="/go/">Go言語</a>
        <li><a href="/gradle/">Gradle</a>
        <li><a href="/web/">HTML/CSS</a>
        <li><a href="/hugo/">Hugo</a>
        <li><a href="/java/">Java</a>
        <li><a href="/js/">JavaScript</a>
        <li><a href="/kotlin/">Kotlin</a>
        <li><a href="/linux/">Linux/Shell</a>
        <li><a href="/mac/">Mac</a>
        <li><a href="/middleman/">Middleman</a>
        <li><a href="/mt/">Meta Trader</a>
        <li><a href="/nodejs/">Node.js</a>
        <li><a href="/octave/">Octave</a>
        <li><a href="/p4/">Perforce</a>
        <li><a href="/perl/">Perl</a>
        <li><a href="/php/">PHP</a>
        <li><a href="/python/">Python</a>
        <li><a href="/r/">R</a>
        <li><a href="/ruby/">Ruby</a>
        <li><a href="/sass/">Sass</a>
        <li><a href="/sed/">sed/awk</a>
        <li><a href="/sql/">SQL</a>
        <li><a href="/tradestation/">トレードステーション</a>
        <li class="xNav-focused"><a href="/vagrant/">Vagrant</a>
        <li><a href="/vba/">VBA</a>
        <li><a href="/vim/">Vim</a>
        <li><a href="/windows/">Windows</a>
  </ul>
</nav>

</div>

  

  <div data-sticky class="xContainer_sidebar_ad">
    <a href="/">
      <figure class="local-logo">
        <img src="/assets/img/kuma_inu.jpg">
        <figcaption>天才まくまくノート</figcaption>
      </figure>
    </a>
  </div>

  <div data-sticky><form action="https://www.google.co.jp/cse" id="cse-search-box">
  <div class="xSearchBar">
    <input type="hidden" name="cx" value="partner-pub-6317852277883092:5930376365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input class="xSearchBar_text" type="search" name="q" placeholder="ノートを検索できます…" size="55" results="5" autocomplete="off" /><input class="xSearchBar_button" type="submit" name="sa" value="&#128269; 検索 " />
  </div>
</form>

</div>
</div>
<div id="xContainer_sidebar_fixed"></div>

</div>
  </div>

  <!-- <div class="xPageFooter"> -->
    

<div class="xBreadCrumbContainer">
  <div class="xBreadCrumb"><a href="/">&#x1F3E0;HOME</a> &gt; <a href="/vagrant/">Vagrant</a></div>
  <div class="xPageDate">2016-10-24</div>
</div>

  <!-- </div> -->
</div>

  <!-- MathJax -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script type="text/javascript" src="/assets/js/fix-sidebar.js"></script>

<!-- maku-common.js -->
<script>
$(function() {
  var $content = $('.xContent');
  // 外部リンクを必ず新しいタブで開く
  $content.find('a[href^=http]').attr('target', '_blank').attr('rel', 'noopener');
  // 外部リンクにクラス属性を付加する
  $content.find('a[href^=http]:not(:has(img))').addClass("xExternalLinkIcon");
});
</script>


</body>
</html>
