<!doctype html><html lang=ja-jp><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>faceswap/ffmpeg で動画の顔を好きな顔に置き換える - まくまく 設計ノート ノート</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X5962TDYXS"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-X5962TDYXS")</script><link rel=icon sizes="16x16 32x32 48x48 64x64" href=../../assets/img/favicon/favicon.ico><link rel=icon sizes=192x192 href=../../assets/img/favicon/192x192.png><link rel=apple-touch-icon href=../../assets/img/favicon/180x180.png><meta name=twitter:card content="summary"><meta property="og:site_name" content="天才まくまくノート"><meta property="og:title" content="faceswap/ffmpeg で動画の顔を好きな顔に置き換える"><meta property="og:type" content="article"><meta property="og:url" content="https://maku77.github.io/p/vfsc5ra/"><meta property="og:locale" content="ja_JP"><meta property="og:image" content="https://maku77.github.io/img/site-logo.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="og:description" content="概要 faceswap というツールを使用すると、機械学習の技術を使用して2人の画像の顔を入れ替えることができます。
このツール自体は静止画を対象としているので、動画の顔を入れ替えることはできないのですが、
ffmpeg を使って動画から静止画を生成 faceswap を使って静止画の顔を入れ替える ffmpeg を使って静止画を結合して動画を生成 というステップを踏むことによって、結果的に動画内の顔を入れ替えるということができます。
faceswap 環境のインストール faceswap のダウンロード まずは、下記サイトの Clone or download ボタンを押して、zip ファイルをダウンロードします（約100MB）。
https://github.com/deepfakes/faceswap faceswap は Python 製のツールであり、tensorflow などパッケージをインストールする必要があります。 Dockerfile が用意されていますので、Docker の実行環境 がインストールされているのであれば、比較的簡単に faceswap の実行環境を整えることができます。 Python 製のツールなので、Virtualenv を使って仮想環境を整えることもできます。
以下、Docker による環境構築方法と、Virtualenv による環境構築方法をそれぞれ示します（本家の INSTALL ドキュメントはこちらの情報が元になっています）。
Docker コンテナで faceswap 環境を作る場合 Docker がインストールされていない (docker コマンドが使えない) 場合は、まずは Docker をインストールします。
Install Docker 例えば Mac であれば、下記から docker.dmg をダウンロードして簡単にインストールできます。
Docker Community Edition for Mac Docker 環境のインストールができたら、faceswap に付属している Dockerfile を使用して、Docker コンテナをビルドします（10分程度かかります）。 ここでは、CPU 版のコンテナを作成します。"><meta property="fb:app_id" content="447708168769292"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6317852277883092" crossorigin=anonymous></script><link rel=stylesheet href=../../css/mm/all.min.03f769de5588c124e5b7baaab243e1f44bc5ccf6139987424d26c43c9491512f.css><link rel=stylesheet href=../../css/all.min.dfed075b80927eec3d408410bcff6d7ec1bbbd82933e2853c49a99f55ed6689b.css></head><body><div class=l-pageHeader><header class=header><a href=../../memo/><img class=header__icon src=../../memo/_index.svg></a><div class=header__right><div class=header__category><a href=../../memo/>まくまく設計ノート</a></div><h1 class=header__title>faceswap/ffmpeg で動画の顔を好きな顔に置き換える</h1></div></header></div><div class=l-withSidebar><div class=l-withSidebar__sidebarLeft><style>#tocStub{position:-webkit-sticky;position:sticky;top:2rem;margin-top:2rem;line-height:1.5;max-height:calc(100vh - 4rem);overflow-y:auto;-webkit-overflow-scrolling:touch}#tocStub ul{font-size:.9em;list-style:none;padding:0;border-top:solid 1px #ccc}#tocStub li{border:solid 1px #ccc;border-right:none;margin-top:-1px}#tocStub a{color:#666;padding:.6em .3em .6em .5em;display:block;text-decoration:none;font-weight:400}.level-2{margin-left:.8em}.level-3{padding-left:1.6em}</style><div id=tocStub></div><script>document.addEventListener("DOMContentLoaded",()=>{function e(e){const t=document.createElement("a");return t.setAttribute("id",e),t}function t(t,n){n.parentNode.insertBefore(e(t),n)}function n(e,t,n){const s=document.createElement("li");return s.classList.add("level-"+e),s.innerHTML='<a href="#'+t+'">'+n+"</a>",s}function s(){const e=document.createElement("ul");return document.querySelectorAll("h2, h3").forEach((s,o)=>{const i="section-"+o;t(i,s);const a=s.tagName.charAt(1)-1;e.appendChild(n(a,i,s.textContent))}),e}document.getElementById("tocStub").appendChild(s())})</script></div><div class=l-withSidebar__content><article class=article itemscope itemtype=https://schema.org/BlogPosting><div class=article__header><div class=breadcrumb><a href=../../>&#x1F3E0;HOME</a> > <a href=../../memo/>まくまく設計ノート</a></div><div style=text-align:right><div class=mm-snsButtons><a rel="nofollow noopener noreferrer" target=_blank href="https://twitter.com/intent/post?url=https%3a%2f%2fmaku77.github.io%2fp%2fvfsc5ra%2f"><span class=mm-snsButtons__icon><svg fill="#000" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932zM17.61 20.644h2.039L6.486 3.24H4.298z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://www.threads.net/intent/post?text=https%3a%2f%2fmaku77.github.io%2fp%2fvfsc5ra%2f" name=HOGE><span class=mm-snsButtons__icon><svg fill="#000" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Threads</title><path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18.0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.589 12c.027 3.086.718 5.496 2.057 7.164 1.43 1.783 3.631 2.698 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.31-.71-.873-1.3-1.634-1.75-.192 1.352-.622 2.446-1.284 3.272-.886 1.102-2.14 1.704-3.73 1.79-1.202.065-2.361-.218-3.259-.801-1.063-.689-1.685-1.74-1.752-2.964-.065-1.19.408-2.285 1.33-3.082.88-.76 2.119-1.207 3.583-1.291a13.853 13.853.0 013.02.142c-.126-.742-.375-1.332-.75-1.757-.513-.586-1.308-.883-2.359-.89h-.029c-.844.0-1.992.232-2.721 1.32L7.734 7.847c.98-1.454 2.568-2.256 4.478-2.256h.044c3.194.02 5.097 1.975 5.287 5.388.108.046.216.094.321.142 1.49.7 2.58 1.761 3.154 3.07.797 1.82.871 4.79-1.548 7.158-1.85 1.81-4.094 2.628-7.277 2.65zm1.003-11.69c-.242.0-.487.007-.739.021-1.836.103-2.98.946-2.916 2.143.067 1.256 1.452 1.839 2.784 1.767 1.224-.065 2.818-.543 3.086-3.71a10.5 10.5.0 00-2.215-.221z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://www.facebook.com/share.php?u=https%3a%2f%2fmaku77.github.io%2fp%2fvfsc5ra%2f"><span class=mm-snsButtons__icon><svg fill="#0866ff" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Facebook</title><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401.0.955.042 1.468.103a8.68 8.68.0 011.141.195v3.325a8.623 8.623.0 00-.653-.036 26.805 26.805.0 00-.733-.009c-.707.0-1.259.096-1.675.309a1.686 1.686.0 00-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://timeline.line.me/social-plugin/share?url=https%3a%2f%2fmaku77.github.io%2fp%2fvfsc5ra%2f&text=faceswap/ffmpeg%20%e3%81%a7%e5%8b%95%e7%94%bb%e3%81%ae%e9%a1%94%e3%82%92%e5%a5%bd%e3%81%8d%e3%81%aa%e9%a1%94%e3%81%ab%e7%bd%ae%e3%81%8d%e6%8f%9b%e3%81%88%e3%82%8b%20-%20%e5%a4%a9%e6%89%8d%e3%81%be%e3%81%8f%e3%81%be%e3%81%8f%e3%83%8e%e3%83%bc%e3%83%88"><span class=mm-snsButtons__icon><svg fill="#00c300" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LINE</title><path d="M19.365 9.863c.349.0.63.285.63.631.0.345-.281.63-.63.63H17.61v1.125h1.755c.349.0.63.283.63.63.0.344-.281.629-.63.629h-2.386c-.345.0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346.0.627.285.627.63.0.349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211.0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346.0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195.0.375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345.0.63.285.63.63v4.771zm-5.741.0c0 .344-.282.629-.631.629-.345.0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346.0.628.285.628.63v4.771zm-2.466.629H4.917c-.345.0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348.0.63.285.63.63v4.141h1.756c.348.0.629.283.629.63.0.344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943.0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://b.hatena.ne.jp/entry?url=https%3a%2f%2fmaku77.github.io%2fp%2fvfsc5ra%2f"><span class=mm-snsButtons__icon><svg fill="#00a4de" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Hatena Bookmark</title><path d="M20.47.0C22.42.0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42.0 20.47V3.53C0 1.58 1.58.0 3.53.0h16.94zm-3.705 14.47c-.78.0-1.41.63-1.41 1.41s.63 1.414 1.41 1.414 1.41-.645 1.41-1.425-.63-1.41-1.41-1.41zM8.61 17.247c1.2.0 2.056-.042 2.58-.12.526-.084.976-.222 1.32-.412.45-.232.78-.564 1.02-.99s.36-.915.36-1.48c0-.78-.21-1.403-.63-1.87-.42-.48-.99-.734-1.74-.794.66-.18 1.156-.45 1.456-.81.315-.344.465-.824.465-1.424.0-.48-.103-.885-.3-1.26-.21-.36-.493-.645-.883-.87-.345-.195-.735-.315-1.215-.405-.464-.074-1.29-.12-2.474-.12H5.654v10.486H8.61zm.736-4.185c.705.0 1.185.088 1.44.262.27.18.39.495.39.93.0.405-.135.69-.42.855-.27.18-.765.254-1.44.254H8.31v-2.297h1.05zm8.656.706v-7.06h-2.46v7.06H18zM8.925 9.08c.71.0 1.185.08 1.432.24.245.16.367.435.367.83.0.38-.13.646-.39.804-.265.154-.747.232-1.452.232h-.57V9.08h.615z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://getpocket.com/edit?url=https%3a%2f%2fmaku77.github.io%2fp%2fvfsc5ra%2f&title=faceswap/ffmpeg%20%e3%81%a7%e5%8b%95%e7%94%bb%e3%81%ae%e9%a1%94%e3%82%92%e5%a5%bd%e3%81%8d%e3%81%aa%e9%a1%94%e3%81%ab%e7%bd%ae%e3%81%8d%e6%8f%9b%e3%81%88%e3%82%8b%20-%20%e5%a4%a9%e6%89%8d%e3%81%be%e3%81%8f%e3%81%be%e3%81%8f%e3%83%8e%e3%83%bc%e3%83%88"><span class=mm-snsButtons__icon><svg fill="#ef3f56" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Pocket</title><path d="M18.813 10.259l-5.646 5.419c-.32.305-.73.458-1.141.458-.41.0-.821-.153-1.141-.458l-5.646-5.419c-.657-.628-.677-1.671-.049-2.326.63-.657 1.671-.679 2.325-.05l4.511 4.322 4.517-4.322c.66-.631 1.697-.607 2.326.049.631.645.615 1.695-.045 2.326l-.011.001zm5.083-7.546c-.299-.858-1.125-1.436-2.041-1.436H2.179c-.9.0-1.717.564-2.037 1.405-.094.25-.142.511-.142.774v7.245l.084 1.441c.348 3.277 2.047 6.142 4.682 8.139.045.036.094.07.143.105l.03.023c1.411 1.03 2.989 1.728 4.694 2.072.786.158 1.591.24 2.389.24.739.0 1.481-.067 2.209-.204.088-.029.176-.045.264-.06.023.0.049-.015.074-.029 1.633-.36 3.148-1.036 4.508-2.025l.029-.031.135-.105c2.627-1.995 4.324-4.862 4.686-8.148L24 10.678V3.445c0-.251-.031-.5-.121-.742l.017.01z"/></svg></span></a></div></div><div class=article__date><time class=pageDate>2018-04-28</time></div></div><div class=article__body><h2 id=概要>概要</h2><p><a href=https://github.com/deepfakes/faceswap>faceswap</a> というツールを使用すると、機械学習の技術を使用して2人の画像の顔を入れ替えることができます。</p><p>このツール自体は静止画を対象としているので、動画の顔を入れ替えることはできないのですが、</p><ol><li><a href=https://www.ffmpeg.org/>ffmpeg</a> を使って動画から静止画を生成</li><li>faceswap を使って静止画の顔を入れ替える</li><li>ffmpeg を使って静止画を結合して動画を生成</li></ol><p>というステップを踏むことによって、結果的に動画内の顔を入れ替えるということができます。</p><h2 id=faceswap-環境のインストール>faceswap 環境のインストール</h2><h3 id=faceswap-のダウンロード>faceswap のダウンロード</h3><p>まずは、下記サイトの Clone or download ボタンを押して、zip ファイルをダウンロードします（約100MB）。</p><ul><li><a href=https://github.com/deepfakes/faceswap>https://github.com/deepfakes/faceswap</a></li></ul><p>faceswap は Python 製のツールであり、tensorflow などパッケージをインストールする必要があります。
<code>Dockerfile</code> が用意されていますので、<a href=../../docker/>Docker の実行環境</a> がインストールされているのであれば、比較的簡単に faceswap の実行環境を整えることができます。
Python 製のツールなので、<a href=../../p/yqjs3aw/>Virtualenv</a> を使って仮想環境を整えることもできます。</p><p>以下、Docker による環境構築方法と、Virtualenv による環境構築方法をそれぞれ示します（本家の <a href=https://github.com/deepfakes/faceswap/blob/master/INSTALL.md>INSTALL ドキュメントはこちら</a>の情報が元になっています）。</p><h3 id=docker-コンテナで-faceswap-環境を作る場合>Docker コンテナで faceswap 環境を作る場合</h3><p>Docker がインストールされていない (<code>docker</code> コマンドが使えない) 場合は、まずは Docker をインストールします。</p><ul><li><a href=https://docs.docker.com/install/>Install Docker</a></li></ul><p>例えば Mac であれば、下記から <code>docker.dmg</code> をダウンロードして簡単にインストールできます。</p><ul><li><a href=https://store.docker.com/editions/community/docker-ce-desktop-mac>Docker Community Edition for Mac</a></li></ul><p>Docker 環境のインストールができたら、faceswap に付属している <code>Dockerfile</code> を使用して、Docker コンテナをビルドします（10分程度かかります）。
ここでは、CPU 版のコンテナを作成します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> <span class=nb>cd</span> faceswap
</span></span><span class=line><span class=cl><span class=gp>$</span> docker build -t deepfakes -f Dockerfile.cpu .
</span></span></code></pre></div><p>コンテナの作成が終わったら、シェルを起動します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> docker run --rm --name deepfakes -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>:/srv -it deepfakes bash
</span></span></code></pre></div><p><code>faceswap.py</code> が実行できるようになっていれば成功です。</p><pre tabindex=0><code>root@xxxxx:/srv# ./faceswap.py -h
</code></pre><h3 id=virtualenv-を使って-faceswap-環境を作る場合>Virtualenv を使って faceswap 環境を作る場合</h3><p>ここでは、Virtualenv による faceswap 実行環境を構築してみます。
MacBook Pro (A1398) で確認しています。
必ずしも Virtualenv を使用する必要はないのですが、Virtualenv を使って実行環境を構築すると、faceswap のためにインストールした Python パッケージ群をその実行環境内に閉じて管理することができます（ディレクトリ削除すれば綺麗な環境に戻る）。
Virtualenv の使い方に関しては、下記に詳しく記述されていますので、使用したことのない方は読んでみてください。
faceswap に限らず、Python 製のツールを使用するときに活用できると思います。</p><ul><li><a href=../../p/yqjs3aw/>Python の実行環境を切り替えて使用する (virtualenv)</a></li></ul><h4 id=1-python3-のインストール>1) Python3 のインストール</h4><p>faceswap は Python スクリプトで作成されているので、Python 3 の処理系をインストールしておく必要があります。
例えば、Mac では Homebrew を使用して下記のようにインストールできます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> brew install python3
</span></span></code></pre></div><h4 id=2-virtualenv-で仮想環境を作成>2) Virtualenv で仮想環境を作成</h4><p>Virtualenv で、faceswap 用の Python 実行環境を作成します。
ここでは、ベタに <code>ENV</code> という名前で作成しましょう。
間違いなく Python 3 の処理系が使われるように、<code>--python</code> オプションを指定しています。
指定しなくても大丈夫かもしれません。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> <span class=nb>cd</span> faceswap
</span></span><span class=line><span class=cl><span class=gp>$</span> virtualenv --python<span class=o>=</span>python3 ENV
</span></span></code></pre></div><h4 id=3-仮想環境のセットアップ>3) 仮想環境のセットアップ</h4><p>Virtualenv で作成した仮想環境内に入り、その中で必要なツール群をインストールしていきます。
NVIDIA の GPU が搭載されていれば、GPU 版の環境を使用することができます。
その場合は、CUDA（GPU 機能を使用するプラットフォーム）、cuDNN（CUDA 用の Deep Learning ライブラリ）をインストールしておく必要があります。</p><ul><li><a href=https://developer.nvidia.com/cuda-downloads>CUDA Download</a></li><li><a href=https://developer.nvidia.com/cudnn>cuDNN Download</a></li></ul><p>faceswap には、pip 用の requirements ファイルが用意されているので、これを使って必要な Python パッケージをまとめてインストールできます。
CPU 用、GPU 用という具合に別れていますので、環境に応じて使い分けてください。</p><pre tabindex=0><code>$ source ENV/bin/activate
(ENV)$ pip install -r requirements-python36.txt           （GPUを使えない場合）
(ENV)$ pip install -r requirements-gpu-python36-cuda9.txt （GPUを使える場合）
</code></pre><p>Mac の場合、下記のような感じで <code>tensorflow</code> パッケージのインストールに失敗することがあります。</p><pre tabindex=0><code>Could not find a version that satisfies the requirement tensorflow-gpu==1.5.0
</code></pre><p>このような場合は、TensorFlow 公式サイトの指示にしたがって、明示的に URL 指定します（参考: <a href=https://www.tensorflow.org/install/install_mac>Installing TensorFlow on macOS</a>）。</p><pre tabindex=0><code>$ sudo pip3 install --upgrade \
    https://storage.googleapis.com/tensorflow/mac/cpu/tensorflow-1.7.0-py3-none-any.whl
</code></pre><p><code>pip</code> によるパッケージインストール時に、<code>cmake</code> が入ってなくて、</p><pre tabindex=0><code>No such file or directory: &#39;cmake&#39;
</code></pre><p>というビルドできない感じのエラーが出たら、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> brew install cmake
</span></span></code></pre></div><p>などで <code>cmake</code> をインストールしてから再チャレンジしてみてください。</p><h2 id=faceswap-で静止画の画像を入れ替える>faceswap で静止画の画像を入れ替える</h2><p><code>faceswap</code> を使用すると、2人の画像の顔を置換することができます（本家の <a href=https://github.com/deepfakes/faceswap/blob/master/USAGE.md>USAGE ドキュメントはこちら</a>）。</p><h3 id=写真から顔を抽出する-extract>写真から顔を抽出する (Extract)</h3><p>ここでは、人物1の写真と人物2の写真をそれぞれ用意し、人物1の写真の中の顔を人物2の顔に入れ替えることを考えます。
作業用の <code>data</code> ディレクトリを作成し、次のような構成で2人の写真を置いてください（少なくとも 64 ファイル以上ないと、スクリプト内で assert が発生するみたいです）。</p><pre tabindex=0><code>+-- faceswap/
     +-- data/
          +-- photos-person1/  （人物1の写真 - この顔を）
          +-- photos-person2/  （人物2の写真 - この顔に入れ替える）
</code></pre><p>次のように実行すると、<code>data/photos-person1</code> の中の写真から顔だけを抽出した画像ファイルが、<code>data/faces-person1</code> に保存されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> ./faceswap.py extract -i data/photos-person1 -o data/faces-person1
</span></span></code></pre></div><p>同様にして、人物2の写真 (<code>data/photos-person2</code>) からも顔画像を抽出すれば完了です。
抽出した顔画像のサイズは、256x256 で統一されています。</p><h3 id=機械学習で顔1から顔2への変換モデルを作成する-train>機械学習で顔1から顔2への変換モデルを作成する (Train)</h3><p>2人分の顔画像が準備できたら、顔1 (<code>data/faces-person1</code>) を顔2 (<code>data/faces-person2</code>) に置き換えるためのモデルデータを作成します。</p><p>次のように実行すると学習が始まり、<code>data/models-person1-person2</code> 以下にモデルデータが作成されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> ./faceswap.py train -A data/faces-person1 -B data/faces-person2 -m data/models-person1-person2
</span></span></code></pre></div><p>この学習処理はものすごく時間がかかりますが、特に CPU で処理している場合は忍耐強く待つ必要があります。</p><p>顔画像のファイル数が少なすぎると、以下のようなアサーションエラーが発生します。</p><pre tabindex=0><code>AssertionError: Number of images is lower than batch-size (Note that too few images may lead to bad training). # images: 13, batch-size: 64
</code></pre><p>メッセージの通り、デフォルトではバッチサイズが 64 となっており、顔画像が 64 ファイル以上ないと怒られます。
バッチサイズは、下記のように <code>-bs (--batch-size)</code> オプションで2のべき乗の値 (64,128,256) を指定できます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> ./faceswap.py train -A data/faces-person1 -B data/faces-person2 -m data/models-person1-person2 -bs ＜2のべき乗＞
</span></span></code></pre></div><h3 id=顔を入れ替える>顔を入れ替える</h3><p>作成したモデルデータ (<code>data/models-person1-person2</code>) を使って、人物1の写真 (<code>data/photos-person1</code>) の顔を入れ替えるには、下記のように実行します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> ./faceswap.py convert -i data/photos-person1 -o data/photos-result -m data/models-person1-person2
</span></span></code></pre></div><p><code>data/photos-result</code> ディレクトリに、結果の写真が格納されます。</p><h2 id=ffmpeg-で動画ファイルの顔を入れ替える>ffmpeg で動画ファイルの顔を入れ替える</h2><p>ffmpeg を使うと、動画ファイルを静止画ファイルに分割したり、逆に、静止画ファイルから動画ファイルを作成したりすることができます。
faceswap では、直接動画ファイル内の顔を置換することはできないので、まずは ffmpeg を使って、動画を静止画に変換しておく必要があります。</p><h3 id=ffmpeg-のインストール>ffmpeg のインストール</h3><p>ffmpeg は下記サイトからダウンロードすることができます。</p><ul><li><a href=https://www.ffmpeg.org/>https://www.ffmpeg.org/</a></li></ul><p>それぞれのプラットフォーム用のパッケージをダウンロードして、<code>ffmpeg</code> ファイルを、パスの通ったディレクトリに置けば OK です。</p><h3 id=動画を静止画ファイルに変換>動画を静止画ファイルに変換</h3><p>ffmpeg を使って動画ファイルから静止画ファイルを生成するには以下のようにします。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>例: video.mp4 から静止画ファイルを生成する</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> mkdir data/photos-someone  <span class=c1># 出力先ディレクトリを作成しておく</span>
</span></span><span class=line><span class=cl><span class=gp>$</span> ffmpeg -i data/video.mp4 -vf <span class=nv>fps</span><span class=o>=</span><span class=m>25</span> data/photos-someone/%06d.png
</span></span></code></pre></div></div></figure><p>上記では <code>fps=25</code>（1 秒あたり 25 枚の静止画）で切り出していますが、学習用のファイルとしては、あまり似たような画像があってもしょうがないので、<code>fps=1</code> などに調整して作成するとよいでしょう。
ただし、最終的に顔の置換対象とする画像ファイル群は、ある程度のフレーム数で切り出しておいて、動画ファイルの形に結合する必要があります。</p><ul><li>学習用の静止画: 1fps</li><li>置換対象の静止画: 25fps</li></ul><p>という感じで作り分けるとよいかもしれません。</p><h3 id=静止画ファイルから動画ファイルに変換>静止画ファイルから動画ファイルに変換</h3><p>静止画ファイルができたら、faceswap を使用して顔の入れ替えなどの画像処理を行います。
画像処理が終わったら、下記のようにして動画ファイルの形に結合することができます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>例: data/photos-result ディレクトリ内の静止画から動画ファイルを生成する</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> ffmpeg -r <span class=m>25</span> -i data/photos-result/%06d.png -vcodec libx264 -pix_fmt yuv420p -r <span class=m>60</span> result.mp4
</span></span></code></pre></div></div></figure><p>最初の <code>-r 25</code> は入力画像のフレームレート（何枚で1分になるか）を表しており、次の <code>-r 60</code> は出力される動画のフレームレートを表しています。</p></div><div class=article__footer><div class=article__date><time class=pageDate>2018-04-28</time></div><div style=text-align:right><div class=mm-snsButtons><a rel="nofollow noopener noreferrer" target=_blank href="https://twitter.com/intent/post?url=https%3a%2f%2fmaku77.github.io%2fp%2fvfsc5ra%2f"><span class=mm-snsButtons__icon><svg fill="#000" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932zM17.61 20.644h2.039L6.486 3.24H4.298z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://www.threads.net/intent/post?text=https%3a%2f%2fmaku77.github.io%2fp%2fvfsc5ra%2f" name=HOGE><span class=mm-snsButtons__icon><svg fill="#000" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Threads</title><path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18.0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.589 12c.027 3.086.718 5.496 2.057 7.164 1.43 1.783 3.631 2.698 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.31-.71-.873-1.3-1.634-1.75-.192 1.352-.622 2.446-1.284 3.272-.886 1.102-2.14 1.704-3.73 1.79-1.202.065-2.361-.218-3.259-.801-1.063-.689-1.685-1.74-1.752-2.964-.065-1.19.408-2.285 1.33-3.082.88-.76 2.119-1.207 3.583-1.291a13.853 13.853.0 013.02.142c-.126-.742-.375-1.332-.75-1.757-.513-.586-1.308-.883-2.359-.89h-.029c-.844.0-1.992.232-2.721 1.32L7.734 7.847c.98-1.454 2.568-2.256 4.478-2.256h.044c3.194.02 5.097 1.975 5.287 5.388.108.046.216.094.321.142 1.49.7 2.58 1.761 3.154 3.07.797 1.82.871 4.79-1.548 7.158-1.85 1.81-4.094 2.628-7.277 2.65zm1.003-11.69c-.242.0-.487.007-.739.021-1.836.103-2.98.946-2.916 2.143.067 1.256 1.452 1.839 2.784 1.767 1.224-.065 2.818-.543 3.086-3.71a10.5 10.5.0 00-2.215-.221z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://www.facebook.com/share.php?u=https%3a%2f%2fmaku77.github.io%2fp%2fvfsc5ra%2f"><span class=mm-snsButtons__icon><svg fill="#0866ff" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Facebook</title><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401.0.955.042 1.468.103a8.68 8.68.0 011.141.195v3.325a8.623 8.623.0 00-.653-.036 26.805 26.805.0 00-.733-.009c-.707.0-1.259.096-1.675.309a1.686 1.686.0 00-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://timeline.line.me/social-plugin/share?url=https%3a%2f%2fmaku77.github.io%2fp%2fvfsc5ra%2f&text=faceswap/ffmpeg%20%e3%81%a7%e5%8b%95%e7%94%bb%e3%81%ae%e9%a1%94%e3%82%92%e5%a5%bd%e3%81%8d%e3%81%aa%e9%a1%94%e3%81%ab%e7%bd%ae%e3%81%8d%e6%8f%9b%e3%81%88%e3%82%8b%20-%20%e5%a4%a9%e6%89%8d%e3%81%be%e3%81%8f%e3%81%be%e3%81%8f%e3%83%8e%e3%83%bc%e3%83%88"><span class=mm-snsButtons__icon><svg fill="#00c300" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LINE</title><path d="M19.365 9.863c.349.0.63.285.63.631.0.345-.281.63-.63.63H17.61v1.125h1.755c.349.0.63.283.63.63.0.344-.281.629-.63.629h-2.386c-.345.0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346.0.627.285.627.63.0.349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211.0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346.0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195.0.375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345.0.63.285.63.63v4.771zm-5.741.0c0 .344-.282.629-.631.629-.345.0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346.0.628.285.628.63v4.771zm-2.466.629H4.917c-.345.0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348.0.63.285.63.63v4.141h1.756c.348.0.629.283.629.63.0.344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943.0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://b.hatena.ne.jp/entry?url=https%3a%2f%2fmaku77.github.io%2fp%2fvfsc5ra%2f"><span class=mm-snsButtons__icon><svg fill="#00a4de" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Hatena Bookmark</title><path d="M20.47.0C22.42.0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42.0 20.47V3.53C0 1.58 1.58.0 3.53.0h16.94zm-3.705 14.47c-.78.0-1.41.63-1.41 1.41s.63 1.414 1.41 1.414 1.41-.645 1.41-1.425-.63-1.41-1.41-1.41zM8.61 17.247c1.2.0 2.056-.042 2.58-.12.526-.084.976-.222 1.32-.412.45-.232.78-.564 1.02-.99s.36-.915.36-1.48c0-.78-.21-1.403-.63-1.87-.42-.48-.99-.734-1.74-.794.66-.18 1.156-.45 1.456-.81.315-.344.465-.824.465-1.424.0-.48-.103-.885-.3-1.26-.21-.36-.493-.645-.883-.87-.345-.195-.735-.315-1.215-.405-.464-.074-1.29-.12-2.474-.12H5.654v10.486H8.61zm.736-4.185c.705.0 1.185.088 1.44.262.27.18.39.495.39.93.0.405-.135.69-.42.855-.27.18-.765.254-1.44.254H8.31v-2.297h1.05zm8.656.706v-7.06h-2.46v7.06H18zM8.925 9.08c.71.0 1.185.08 1.432.24.245.16.367.435.367.83.0.38-.13.646-.39.804-.265.154-.747.232-1.452.232h-.57V9.08h.615z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://getpocket.com/edit?url=https%3a%2f%2fmaku77.github.io%2fp%2fvfsc5ra%2f&title=faceswap/ffmpeg%20%e3%81%a7%e5%8b%95%e7%94%bb%e3%81%ae%e9%a1%94%e3%82%92%e5%a5%bd%e3%81%8d%e3%81%aa%e9%a1%94%e3%81%ab%e7%bd%ae%e3%81%8d%e6%8f%9b%e3%81%88%e3%82%8b%20-%20%e5%a4%a9%e6%89%8d%e3%81%be%e3%81%8f%e3%81%be%e3%81%8f%e3%83%8e%e3%83%bc%e3%83%88"><span class=mm-snsButtons__icon><svg fill="#ef3f56" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Pocket</title><path d="M18.813 10.259l-5.646 5.419c-.32.305-.73.458-1.141.458-.41.0-.821-.153-1.141-.458l-5.646-5.419c-.657-.628-.677-1.671-.049-2.326.63-.657 1.671-.679 2.325-.05l4.511 4.322 4.517-4.322c.66-.631 1.697-.607 2.326.049.631.645.615 1.695-.045 2.326l-.011.001zm5.083-7.546c-.299-.858-1.125-1.436-2.041-1.436H2.179c-.9.0-1.717.564-2.037 1.405-.094.25-.142.511-.142.774v7.245l.084 1.441c.348 3.277 2.047 6.142 4.682 8.139.045.036.094.07.143.105l.03.023c1.411 1.03 2.989 1.728 4.694 2.072.786.158 1.591.24 2.389.24.739.0 1.481-.067 2.209-.204.088-.029.176-.045.264-.06.023.0.049-.015.074-.029 1.633-.36 3.148-1.036 4.508-2.025l.029-.031.135-.105c2.627-1.995 4.324-4.862 4.686-8.148L24 10.678V3.445c0-.251-.031-.5-.121-.742l.017.01z"/></svg></span></a></div></div><div class=breadcrumb><a href=../../>&#x1F3E0;HOME</a> > <a href=../../memo/>まくまく設計ノート</a></div></div></article><script>const SIDEBAR_HIDE_THRESHOLD=800,SIDEBAR_WIDTH=250,OFFSET=10;let w=window.innerWidth;w>=SIDEBAR_HIDE_THRESHOLD&&(w-=SIDEBAR_WIDTH),w-=OFFSET,w>=728?rakuten_size="728x200":w>=600?rakuten_size="600x200":w>=468?rakuten_size="468x160":w>=336?rakuten_size="336x280":w>=300?rakuten_size="300x250":w>=250?rakuten_size="250x250":rakuten_size="200x350",rakuten_design="slide",rakuten_affiliateId="1239b074.74af6526.1239b075.bc72ef6e",rakuten_items="ctsmatch",rakuten_genreId=0,rakuten_target="_blank",rakuten_theme="gray",rakuten_border="off",rakuten_auto_mode="on",rakuten_genre_title="off",rakuten_recommend="on",rakuten_txtColor="333333",rakuten_moverColor="30C030",rakuten_bgColor="FFFFFF",rakuten_captionColor="333333"</script><script src=https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js></script></div><div class=l-withSidebar__sidebarRight><nav class=navigation><div class=navigation__header>カテゴリ一覧</div><ul><li><a class="navigation__item navigation__item--focused" href=https://maku77.github.io/memo/>いろいろ</a><li><a class=navigation__item href=https://maku77.github.io/android/>Android</a><li><a class=navigation__item href=https://maku.blog/p/8t6hr3d/>Ansible</a><li><a class=navigation__item href=https://maku77.github.io/blender/>Blender</a><li><a class=navigation__item href=https://maku77.github.io/cpp/>C/C++</a><li><a class=navigation__item href=https://maku77.github.io/docker/>Docker</a><li><a class=navigation__item href=https://maku77.github.io/git/>Git</a><li><a class=navigation__item href=https://maku77.github.io/go/>Go言語</a><li><a class=navigation__item href=https://maku77.github.io/gradle/>Gradle</a><li><a class=navigation__item href=https://maku77.github.io/web/>HTML/CSS</a><li><a class=navigation__item href=https://maku77.github.io/hugo/>Hugo</a><li><a class=navigation__item href=https://maku77.github.io/java/>Java</a><li><a class=navigation__item href=https://maku77.github.io/js/>JavaScript</a><li><a class=navigation__item href=https://maku77.github.io/kotlin/>Kotlin</a><li><a class=navigation__item href=https://maku77.github.io/linux/>Linux/Shell</a><li><a class=navigation__item href=https://maku77.github.io/mac/>Mac</a><li><a class=navigation__item href=https://maku77.github.io/middleman/>Middleman</a><li><a class=navigation__item href=https://toushi.maku.blog/p/etedykx/>MetaTrader</a><li><a class=navigation__item href=https://maku77.github.io/nodejs/>Node.js</a><li><a class=navigation__item href=https://maku77.github.io/octave/>Octave</a><li><a class=navigation__item href=https://maku77.github.io/p4/>Perforce</a><li><a class=navigation__item href=https://maku77.github.io/perl/>Perl</a><li><a class=navigation__item href=https://maku77.github.io/php/>PHP</a><li><a class=navigation__item href=https://maku77.github.io/python/>Python</a><li><a class=navigation__item href=https://maku77.github.io/r/>R</a><li><a class=navigation__item href=https://maku77.github.io/ruby/>Ruby</a><li><a class=navigation__item href=https://maku77.github.io/rust/>Rust</a><li><a class=navigation__item href=https://maku77.github.io/sass/>Sass</a><li><a class=navigation__item href=https://maku77.github.io/sed/>sed/awk</a><li><a class=navigation__item href=https://maku77.github.io/sql/>SQL</a><li><a class=navigation__item href=https://maku77.github.io/tradestation/>トレードステーション</a><li><a class=navigation__item href=https://maku77.github.io/vagrant/>Vagrant</a><li><a class=navigation__item href=https://maku77.github.io/vba/>VBA</a><li><a class=navigation__item href=https://maku77.github.io/vim/>Vim</a><li><a class=navigation__item href=https://maku77.github.io/windows/>Windows</a></ul></nav><style>.codoc-support{display:inline-block;margin:0!important;padding:12px!important;width:200px!important;max-width:100%}.codoc-support .codoc-support-title{font-size:smaller!important;white-space:nowrap;margin-bottom:12px!important}.codoc-support .codoc-btn{width:160px!important}</style><script src=https://codoc.jp/js/cms.js data-css=black data-usercode=tp6ZPzTj3w defer></script><div id=codoc-entry-4gYwTntzzw class=codoc-entries data-without-body=1 data-support-button-text="（っ'-')╮シュッ🔴" data-show-like=0 data-show-about-codoc=0 data-show-powered-by=0 data-support-message=まくに投げ銭できます。></div></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.querySelectorAll("a[href^=http]");for(let n=0;n<e.length;++n){const t=e[n];if(t.href.startsWith("https://maku77.github.io"))continue;const s=t.getElementsByTagName("img");if(s.length>0)continue;const o=t.getElementsByTagName("svg");if(o.length>0)continue;t.classList.add("xExternalLinkIcon"),t.setAttribute("target","_blank"),t.setAttribute("rel","noopener")}})</script></body></html>