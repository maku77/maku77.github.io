<!doctype html><html lang=ja-jp><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>make を使いこなすためのメモ - まくまく 設計ノート ノート</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X5962TDYXS"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-X5962TDYXS")</script><link rel=icon sizes="16x16 32x32 48x48 64x64" href=../../assets/img/favicon/favicon.ico><link rel=icon sizes=192x192 href=../../assets/img/favicon/192x192.png><link rel=apple-touch-icon href=../../assets/img/favicon/180x180.png><meta name=twitter:card content="summary"><meta property="og:site_name" content="天才まくまくノート"><meta property="og:title" content="make を使いこなすためのメモ"><meta property="og:type" content="article"><meta property="og:url" content="https://maku77.github.io/p/3r6ds3r/"><meta property="og:locale" content="ja_JP"><meta property="og:image" content="https://maku77.github.io/img/site-logo.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="og:description" content="make の種類あれこれ 一番よく使用されているのは GNU make ですが、いろいろな亜種があります。
System V make Stuart I. Feldman によって作成されたオリジナルの make です GNU make Linux の世界で一般的に使用されている make です Implemented by Richard Stallman and Roland McGrath. Development since Version 3.76 has been handled by Paul D. Smith. Microsoft 版 nmake Microsoft C コンパイラ ver. 6.0A に付属 Borland 版 make Borland Turbo C++ コンパイラ ver.2 に付属 参考: MAKE の達人 (1992)
Makefile に記述する rule のフォーマット Makefile には、下記のようなフォーマットで rule を記述していきます。
targets : prerequisites command ."><meta property="fb:app_id" content="447708168769292"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6317852277883092" crossorigin=anonymous></script><link rel=stylesheet href=../../css/mm/all.min.03f769de5588c124e5b7baaab243e1f44bc5ccf6139987424d26c43c9491512f.css><link rel=stylesheet href=../../css/all.min.a1be5c135c2d519bef49b4b099f4964b99ee878b81b26e9bac24497d0a73c31f.css></head><body><div class=l-pageHeader><header class=header><a href=../../memo/><img class=header__icon src=../../memo/_index.svg></a><div class=header__right><div class=header__category><a href=../../memo/>まくまく設計ノート</a></div><h1 class=header__title>make を使いこなすためのメモ</h1></div></header></div><div class=l-withSidebar><div class=l-withSidebar__sidebarLeft><style>#tocStub{position:-webkit-sticky;position:sticky;top:2rem;margin-top:2rem;line-height:1.5;max-height:calc(100vh - 4rem);overflow-y:auto;-webkit-overflow-scrolling:touch}#tocStub ul{font-size:.9em;list-style:none;padding:0;border-top:solid 1px #ccc}#tocStub li{border:solid 1px #ccc;border-right:none;margin-top:-1px}#tocStub a{color:#666;padding:.6em .3em .6em .5em;display:block;text-decoration:none;font-weight:400}.level-2{margin-left:.8em}.level-3{padding-left:1.6em}</style><div id=tocStub></div><script>document.addEventListener("DOMContentLoaded",()=>{function e(e){const t=document.createElement("a");return t.setAttribute("id",e),t}function t(t,n){n.parentNode.insertBefore(e(t),n)}function n(e,t,n){const s=document.createElement("li");return s.classList.add("level-"+e),s.innerHTML='<a href="#'+t+'">'+n+"</a>",s}function s(){const e=document.createElement("ul");return document.querySelectorAll("h2, h3").forEach((s,o)=>{const i="section-"+o;t(i,s);const a=s.tagName.charAt(1)-1;e.appendChild(n(a,i,s.textContent))}),e}document.getElementById("tocStub").appendChild(s())})</script></div><div class=l-withSidebar__content><article class=article itemscope itemtype=https://schema.org/BlogPosting><div class=article__header><div class=breadcrumb><a href=../../>&#x1F3E0;HOME</a> > <a href=../../memo/>まくまく設計ノート</a></div><div style=text-align:right><div class=mm-snsButtons><a rel="nofollow noopener noreferrer" target=_blank href="https://twitter.com/intent/post?url=https%3a%2f%2fmaku77.github.io%2fp%2f3r6ds3r%2f"><span class=mm-snsButtons__icon><svg fill="#000" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932zM17.61 20.644h2.039L6.486 3.24H4.298z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://www.threads.net/intent/post?text=https%3a%2f%2fmaku77.github.io%2fp%2f3r6ds3r%2f" name=HOGE><span class=mm-snsButtons__icon><svg fill="#000" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Threads</title><path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18.0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.589 12c.027 3.086.718 5.496 2.057 7.164 1.43 1.783 3.631 2.698 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.31-.71-.873-1.3-1.634-1.75-.192 1.352-.622 2.446-1.284 3.272-.886 1.102-2.14 1.704-3.73 1.79-1.202.065-2.361-.218-3.259-.801-1.063-.689-1.685-1.74-1.752-2.964-.065-1.19.408-2.285 1.33-3.082.88-.76 2.119-1.207 3.583-1.291a13.853 13.853.0 013.02.142c-.126-.742-.375-1.332-.75-1.757-.513-.586-1.308-.883-2.359-.89h-.029c-.844.0-1.992.232-2.721 1.32L7.734 7.847c.98-1.454 2.568-2.256 4.478-2.256h.044c3.194.02 5.097 1.975 5.287 5.388.108.046.216.094.321.142 1.49.7 2.58 1.761 3.154 3.07.797 1.82.871 4.79-1.548 7.158-1.85 1.81-4.094 2.628-7.277 2.65zm1.003-11.69c-.242.0-.487.007-.739.021-1.836.103-2.98.946-2.916 2.143.067 1.256 1.452 1.839 2.784 1.767 1.224-.065 2.818-.543 3.086-3.71a10.5 10.5.0 00-2.215-.221z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://www.facebook.com/share.php?u=https%3a%2f%2fmaku77.github.io%2fp%2f3r6ds3r%2f"><span class=mm-snsButtons__icon><svg fill="#0866ff" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Facebook</title><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401.0.955.042 1.468.103a8.68 8.68.0 011.141.195v3.325a8.623 8.623.0 00-.653-.036 26.805 26.805.0 00-.733-.009c-.707.0-1.259.096-1.675.309a1.686 1.686.0 00-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://timeline.line.me/social-plugin/share?url=https%3a%2f%2fmaku77.github.io%2fp%2f3r6ds3r%2f&text=make%20%e3%82%92%e4%bd%bf%e3%81%84%e3%81%93%e3%81%aa%e3%81%99%e3%81%9f%e3%82%81%e3%81%ae%e3%83%a1%e3%83%a2%20-%20%e5%a4%a9%e6%89%8d%e3%81%be%e3%81%8f%e3%81%be%e3%81%8f%e3%83%8e%e3%83%bc%e3%83%88"><span class=mm-snsButtons__icon><svg fill="#00c300" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LINE</title><path d="M19.365 9.863c.349.0.63.285.63.631.0.345-.281.63-.63.63H17.61v1.125h1.755c.349.0.63.283.63.63.0.344-.281.629-.63.629h-2.386c-.345.0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346.0.627.285.627.63.0.349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211.0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346.0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195.0.375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345.0.63.285.63.63v4.771zm-5.741.0c0 .344-.282.629-.631.629-.345.0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346.0.628.285.628.63v4.771zm-2.466.629H4.917c-.345.0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348.0.63.285.63.63v4.141h1.756c.348.0.629.283.629.63.0.344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943.0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://b.hatena.ne.jp/entry?url=https%3a%2f%2fmaku77.github.io%2fp%2f3r6ds3r%2f"><span class=mm-snsButtons__icon><svg fill="#00a4de" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Hatena Bookmark</title><path d="M20.47.0C22.42.0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42.0 20.47V3.53C0 1.58 1.58.0 3.53.0h16.94zm-3.705 14.47c-.78.0-1.41.63-1.41 1.41s.63 1.414 1.41 1.414 1.41-.645 1.41-1.425-.63-1.41-1.41-1.41zM8.61 17.247c1.2.0 2.056-.042 2.58-.12.526-.084.976-.222 1.32-.412.45-.232.78-.564 1.02-.99s.36-.915.36-1.48c0-.78-.21-1.403-.63-1.87-.42-.48-.99-.734-1.74-.794.66-.18 1.156-.45 1.456-.81.315-.344.465-.824.465-1.424.0-.48-.103-.885-.3-1.26-.21-.36-.493-.645-.883-.87-.345-.195-.735-.315-1.215-.405-.464-.074-1.29-.12-2.474-.12H5.654v10.486H8.61zm.736-4.185c.705.0 1.185.088 1.44.262.27.18.39.495.39.93.0.405-.135.69-.42.855-.27.18-.765.254-1.44.254H8.31v-2.297h1.05zm8.656.706v-7.06h-2.46v7.06H18zM8.925 9.08c.71.0 1.185.08 1.432.24.245.16.367.435.367.83.0.38-.13.646-.39.804-.265.154-.747.232-1.452.232h-.57V9.08h.615z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://getpocket.com/edit?url=https%3a%2f%2fmaku77.github.io%2fp%2f3r6ds3r%2f&title=make%20%e3%82%92%e4%bd%bf%e3%81%84%e3%81%93%e3%81%aa%e3%81%99%e3%81%9f%e3%82%81%e3%81%ae%e3%83%a1%e3%83%a2%20-%20%e5%a4%a9%e6%89%8d%e3%81%be%e3%81%8f%e3%81%be%e3%81%8f%e3%83%8e%e3%83%bc%e3%83%88"><span class=mm-snsButtons__icon><svg fill="#ef3f56" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Pocket</title><path d="M18.813 10.259l-5.646 5.419c-.32.305-.73.458-1.141.458-.41.0-.821-.153-1.141-.458l-5.646-5.419c-.657-.628-.677-1.671-.049-2.326.63-.657 1.671-.679 2.325-.05l4.511 4.322 4.517-4.322c.66-.631 1.697-.607 2.326.049.631.645.615 1.695-.045 2.326l-.011.001zm5.083-7.546c-.299-.858-1.125-1.436-2.041-1.436H2.179c-.9.0-1.717.564-2.037 1.405-.094.25-.142.511-.142.774v7.245l.084 1.441c.348 3.277 2.047 6.142 4.682 8.139.045.036.094.07.143.105l.03.023c1.411 1.03 2.989 1.728 4.694 2.072.786.158 1.591.24 2.389.24.739.0 1.481-.067 2.209-.204.088-.029.176-.045.264-.06.023.0.049-.015.074-.029 1.633-.36 3.148-1.036 4.508-2.025l.029-.031.135-.105c2.627-1.995 4.324-4.862 4.686-8.148L24 10.678V3.445c0-.251-.031-.5-.121-.742l.017.01z"/></svg></span></a></div></div><div class=article__date><time class=pageDate>2007-06-29</time></div></div><div class=article__body><h2 id=make-の種類あれこれ>make の種類あれこれ</h2><p>一番よく使用されているのは GNU make ですが、いろいろな亜種があります。</p><ul><li>System V make<ul><li>Stuart I. Feldman によって作成されたオリジナルの make です</li></ul></li><li>GNU make<ul><li>Linux の世界で一般的に使用されている make です</li><li>Implemented by Richard Stallman and Roland McGrath.</li><li>Development since Version 3.76 has been handled by Paul D. Smith.</li></ul></li><li>Microsoft 版 nmake<ul><li>Microsoft C コンパイラ ver. 6.0A に付属</li></ul></li><li>Borland 版 make<ul><li>Borland Turbo C++ コンパイラ ver.2 に付属</li></ul></li></ul><p>参考: MAKE の達人 (1992)</p><h2 id=makefile-に記述する-rule-のフォーマット>Makefile に記述する rule のフォーマット</h2><p>Makefile には、下記のようなフォーマットで rule を記述していきます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>targets </span><span class=o>:</span> <span class=n>prerequisites</span>
</span></span><span class=line><span class=cl>	<span class=nb>command</span>
</span></span><span class=line><span class=cl>	...
</span></span></code></pre></div><p>あるいは、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>targets </span><span class=o>:</span> <span class=n>prerequisites</span> ; <span class=n>command</span>
</span></span><span class=line><span class=cl>	<span class=nb>command</span>
</span></span><span class=line><span class=cl>	...
</span></span></code></pre></div><p>それぞれ、下記のような内容を記述していきます。</p><dl><dt>targets</dt><dd>更新（あるいは作成）する対象となるファイルを指定します。複数のファイル名を指定する場合はスペースで区切ります。ワイルドカードを使ってファイル名を指定することもできます。</dd><dt>prerequisites</dt><dd>targets の更新（あるいは作成）に必要なファイル郡を指定します。複数のファイル名を指定する場合はスペースで区切ります。ワイルドカードを使ってファイル名を指定することもできます。</dd><dt>command</dt><dd>targets を更新（あるいは作成）するためのコマンド郡を指定します。command 行は必ず TAB で始めること。複数のコマンドを指定する場合は、次の行に記述するか、セミコロン (<code>;</code>) で区切ります。</dd></dl><p>上記のような target の処理内容をまとめて <strong>rule</strong> と呼びます。
１つの target を複数の rule に分けて記述することも可能ですが、そのような書き方は見通しが悪くなるため、おすすめはできません。</p><h2 id=make-コマンドの振る舞い>make コマンドの振る舞い</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>target ... </span><span class=o>:</span> <span class=n>prerequisites</span> ...
</span></span><span class=line><span class=cl>	<span class=nb>command</span>
</span></span><span class=line><span class=cl>	...
</span></span></code></pre></div><p><code>make</code> コマンドを実行したとき、上記のように指定された command は以下のようなルールで実行されます。</p><ol><li>target を指定せずに <code>make</code> を実行すると、Makefile の最初に出てくる target を処理する（ドット (<code>.</code>) で始まる target を除く）。この target のことを <strong>default goal</strong> と呼ぶ。</li><li>target に指定したファイルが存在しない場合、あるいは、target が prerequisites に指定したファイルより古い場合は command が実行される。prerequisites は空でもよく、その場合は、target と同じ名前のファイルがない場合だけ command が実行される。</li><li>prerequisites に指定したものと同じ名前の target がある場合は、その target を先に評価する。</li></ol><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile の例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>app </span><span class=o>:</span> <span class=n>main</span>.<span class=n>o</span> <span class=n>util</span>.<span class=n>o</span>
</span></span><span class=line><span class=cl>	cc -o app main.o util.o
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>main.o </span><span class=o>:</span> <span class=n>main</span>.<span class=n>c</span> <span class=n>util</span>.<span class=n>h</span>
</span></span><span class=line><span class=cl>	cc -c main.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>util.o </span><span class=o>:</span> <span class=n>util</span>.<span class=n>c</span> <span class=n>util</span>.<span class=n>h</span>
</span></span><span class=line><span class=cl>	cc -c util.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>.PHONY </span><span class=o>:</span> <span class=n>clean</span>
</span></span><span class=line><span class=cl><span class=nf>clean </span><span class=o>:</span>
</span></span><span class=line><span class=cl>	rm app main.o util.o
</span></span></code></pre></div></div></figure><h2 id=variables変数を使用する>Variables（変数）を使用する</h2><p><code>Makefile</code> 内に同じ内容を何度も記述しなければいけない場合は、その内容を変数に入れておくことで簡潔に記述できるようになります。
例えば、オブジェクトファイル (<code>.o</code>) のリストはよく、<code>objects</code>、<code>OBJECTS</code>、<code>objs</code>、<code>OBJS</code>、<code>obj</code>、<code>OBJ</code> といった名前の変数で表現されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>OBJECTS</span> <span class=o>=</span> obj1.o obj2.o obj3.o
</span></span></code></pre></div><p>変数の内容を取り出すには、<code>$(OBJECTS)</code> のように参照します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Variables（変数）を使った Makefile の例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>objects</span> <span class=o>=</span> main.o util.o
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>app </span><span class=o>:</span> <span class=k>$(</span><span class=nv>OBJECTS</span><span class=k>)</span>
</span></span><span class=line><span class=cl>	cc -o app <span class=k>$(</span>OBJECTS<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>main.o </span><span class=o>:</span> <span class=n>main</span>.<span class=n>c</span> <span class=n>util</span>.<span class=n>h</span>
</span></span><span class=line><span class=cl>	cc -c main.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>util.o </span><span class=o>:</span> <span class=n>util</span>.<span class=n>c</span> <span class=n>util</span>.<span class=n>h</span>
</span></span><span class=line><span class=cl>	cc -c util.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>.PHONY </span><span class=o>:</span> <span class=n>clean</span>
</span></span><span class=line><span class=cl><span class=nf>clean </span><span class=o>:</span>
</span></span><span class=line><span class=cl>	rm app <span class=k>$(</span>OBJECTS<span class=k>)</span>
</span></span></code></pre></div></div></figure><h2 id=オブジェクトファイル-o-を作る-rule-の省略記法>オブジェクトファイル (.o) を作る rule の省略記法</h2><p>ソースファイル <code>util.c</code>、<code>util.h</code> をコンパイルして <code>util.o</code> ファイルを作る rule を記述する場合、<strong>implicit rules（暗黙のルール）</strong> を使用して rule 記述を省略することができます。
ここでは、prerequisites から <code>.c</code> ファイルの記述を省略し、command の記述を省略することができます。
例えば、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>util.o </span><span class=o>:</span> <span class=n>util</span>.<span class=n>c</span> <span class=n>util</span>.<span class=n>h</span>
</span></span><span class=line><span class=cl>	cc -c util.c
</span></span></code></pre></div><p>このような rule は、implicit rules によって以下のように 1 行で記述することができます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>util.o </span><span class=o>:</span> <span class=n>util</span>.<span class=n>h</span>
</span></span></code></pre></div><figure class=xCodeBlock><figcaption class=xCodeBlock_title>長めのサンプル</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>OBJECTS</span> <span class=o>=</span> main.o util.o
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>app </span><span class=o>:</span> <span class=k>$(</span><span class=nv>OBJECTS</span><span class=k>)</span>
</span></span><span class=line><span class=cl>	cc -o app <span class=k>$(</span>OBJECTS<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>main.o </span><span class=o>:</span> <span class=n>main</span>.<span class=n>c</span> <span class=n>util</span>.<span class=n>h</span>
</span></span><span class=line><span class=cl>	cc -c main.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>util.o </span><span class=o>:</span> <span class=n>util</span>.<span class=n>c</span> <span class=n>util</span>.<span class=n>h</span>
</span></span><span class=line><span class=cl>	cc -c util.c
</span></span></code></pre></div></div></figure><p>これを、以下のように省略して記述することができます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>OBJECTS</span> <span class=o>=</span> main.o util.o
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>app </span><span class=o>:</span> <span class=k>$(</span><span class=nv>OBJECTS</span><span class=k>)</span>
</span></span><span class=line><span class=cl>	cc -o app <span class=k>$(</span>OBJECTS<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>main.o </span><span class=o>:</span> <span class=n>util</span>.<span class=n>h</span>
</span></span><span class=line><span class=cl><span class=nf>util.o </span><span class=o>:</span> <span class=n>util</span>.<span class=n>h</span>
</span></span></code></pre></div><p><code>main.o</code> と <code>util.o</code> は同じ prerequisites（ここでは <code>util.h</code>）を持つので、一行にまとめて以下のようにも書けます。
ただし、このように target をまとめることを好まない人もいます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>OBJECTS</span> <span class=o>=</span> main.o util.o
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>app </span><span class=o>:</span> <span class=k>$(</span><span class=nv>OBJECTS</span><span class=k>)</span>
</span></span><span class=line><span class=cl>	cc -o app <span class=k>$(</span>OBJECTS<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(OBJECTS) </span><span class=o>:</span> <span class=n>util</span>.<span class=n>h</span>
</span></span></code></pre></div><h2 id=makefile-の名前>Makefile の名前</h2><p>GNU make は、以下の順番で <code>Makefile</code> を探します。</p><ol><li>GNUmakefile（GNU make 以外の make はこのファイルを検索しない）</li><li>makefile</li><li>Makefile（推奨）</li></ol><p>GNU make のマニュアルでは、<code>Makefile</code> という名前にすることを推奨しています。
これは、ディレクトリ内のファイルリストを表示したときに、比較的前の方に表示され、<code>README</code> ファイルの近くに表示される可能性が高いからです。</p><h2 id=別の-makefile-を-include-する>別の Makefile を include する</h2><h3 id=include-の構文>include の構文</h3><p>下記のような構文を使用すると、Makefile の中から別のファイルをインクルードすることができます。</p><pre tabindex=0><code>include filenames...
</code></pre><p>ファイル名にはシェルのファイル名パターンを使用することができます。</p><pre tabindex=0><code>include *.mk
</code></pre><p>ファイル名の中で変数 (variable) や関数 (function) を参照すると、展開されてからファイルを検索します。</p><pre tabindex=0><code>HOGE = foo.mk bar.mk
include $(HOGE)
</code></pre><h3 id=include-される-makefile-の検索パス>include される Makefile の検索パス</h3><p>インクルードする Makefile を相対パスで指定した場合、以下のような順番で検索されます。</p><ol><li>カレントディレクトリ</li><li><code>-I</code> または <code>--include-dir</code> オプションで指定したディレクトリ</li><li><code>&lt;prefix>/include</code>（通常は <code>/usr/local/include</code>）</li><li><code>/usr/gnu/include</code></li><li><code>/usr/local/include</code></li><li><code>/usr/include</code></li></ol><h3 id=インクルードする-makefile-が見つからなかったときのエラーを抑制する>インクルードする Makefile が見つからなかったときのエラーを抑制する</h3><p>デフォルトでは、インクルードしようとしたファイルが見つからなかったときはエラーになります。
ファイルが見つからなかった場合にエラーを出さないようにするには、<code>include</code> の前にハイフンを付けて、<code>-include</code> と記述します。</p><pre tabindex=0><code>-include filenames...
</code></pre><p>GNU make 以外の make 実装では、<code>-include</code> の代わりに <code>sinclude</code> を使用するものもあります。</p><h2 id=どんなターゲット名にも一致する->どんなターゲット名にも一致する %</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo all
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>%</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo %
</span></span></code></pre></div><p>上記のように、ターゲット名に <code>%</code> を指定すると、任意のターゲット名に一致するものとみなされます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make       ⇒ ターゲット all を実行
</span></span><span class=line><span class=cl><span class=gp>$</span> make all   ⇒ ターゲット all を実行
</span></span><span class=line><span class=cl><span class=gp>$</span> make hoge  ⇒ ターゲット % を実行
</span></span></code></pre></div><h2 id=make-の２フェイズ処理変数の展開順序について>make の２フェイズ処理（変数の展開順序について）</h2><p><code>make</code> コマンドが <code>Makefile</code> を処理するとき、次のように 2 フェイズに分けて処理されます。</p><ol><li><strong>Read-in phase (1st phase):</strong> make を実行すると、最初に Makefile の内容をすべて読み込み（インクルードしたファイルもすべて）、各ルールの依存関係や、変数の値などを内部に保持します。</li><li><strong>Target-update phase (2nd phase):</strong> 1st phase で構築された内部構造を用い、各ルールを処理します。</li></ol><p>この知識は、Makefile 内で変数がどのような順序で展開されるかを理解するために必要になってきます。
例えば、以下のような <code>Makefile</code> を実行すると、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>FOO</span> <span class=o>=</span> <span class=m>100</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo <span class=k>$(</span>FOO<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>FOO</span> <span class=o>=</span> <span class=m>200</span>
</span></span></code></pre></div><p>Read-in phase では <code>$(FOO)</code> の値は展開されず、<code>echo</code> コマンドが実行される Target-update phase で <code>$(FOO)</code> の値が展開されるため、<code>echo</code> される値は <code>200</code> となります。</p><p>変数の展開タイミングは、Makefile 内のどの位置で変数が使われているかによって変わってきます。
以下は、Makefile 内で記述できるフォーマットを羅列したものですが、この中の <code>&lt;immediate></code> と書かれた部分は、1st phase で展開される（その時点で格納されている値が使用される）ことを表しています。
<code>&lt;deferred></code> と書かれた部分は、1st phase では展開されない（Makefile を最後まで読んで再帰的に展開される）ことを表しています。</p><pre tabindex=0><code>&lt;immediate&gt; = &lt;deferred&gt;
&lt;immediate&gt; ?= &lt;deferred&gt;
&lt;immediate&gt; := &lt;immediate&gt;
&lt;immediate&gt; += &lt;deferred&gt; or &lt;immediate&gt;
              （右辺に指定した変数が := で作成されたものなら &lt;immediate&gt; となる）

define &lt;immediate&gt;
	&lt;deferred&gt;
endif

&lt;immediate&gt; : &lt;immediate&gt; ; &lt;deferred&gt;
	&lt;deferred&gt;
</code></pre><h2 id=ワイルドカードを使う>ワイルドカードを使う</h2><h3 id=rule-の定義にワイルドカードを使う>rule の定義にワイルドカードを使う</h3><p>target や prerequisite の指定には、Bourne シェルのワイルドカードを使用することができます。
command でワイルドカードを使うと、そのコマンドを実行するシェルによって展開されます。</p><ul><li><code>*</code> &mldr; 任意の文字列</li><li><code>?</code> &mldr; 任意の 1 文字</li><li><code>~</code> &mldr; ホームディレクトリ（Windows の場合は <code>HOME</code> 環境変数の値）</li><li><code>~john</code> &mldr; john のホームディレクトリ</li></ul><figure class=xCodeBlock><figcaption class=xCodeBlock_title>ワイルドカードを使った Makefile の例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	rm -f *.o
</span></span></code></pre></div></div></figure><h3 id=変数の定義にワイルドカードを使う>変数の定義にワイルドカードを使う</h3><p>変数を定義するときにワイルドカードを展開したい場合は、<strong><code>wildcard</code></strong> 関数を使用します。
例えば、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>OBJECTS</span> <span class=o>=</span> *.o
</span></span></code></pre></div><p>とすると、<code>OBJECTS</code> の値は <code>*.o</code> のままになります。
この <code>*.o</code> を展開したものを <code>OBJECTS</code> に代入したい場合は、次のように記述する必要があります。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>OBJECTS</span> <span class=o>:=</span> <span class=k>$(</span>wildcard *.o<span class=k>)</span>
</span></span></code></pre></div><p>右辺の関数やワイルドカードを代入時に展開するために、代入演算子として <code>=</code> ではなく、<code>:=</code> を使用している点に注意してください。</p><h3 id=ワイルドカードのエスケープ>ワイルドカードのエスケープ</h3><p>ファイル名の中に <code>*</code> を含むものを指定したい場合は、バックスラッシュ (<code>\</code>) でエスケープします。</p><pre tabindex=0><code>foo\*.c  ==&gt; &#39;foo*.c&#39; というファイル名を示す
</code></pre><p>このエスケープ処理は、Windows のパス指定でバックスラッシュ (<code>/</code>) を含む場合にしばしば問題になります。
例えば、<code>C:\foo</code> ディレクトリの下の <code>.cpp</code> ファイルをワイルドカードで示したい場合に、</p><pre tabindex=0><code>C:\foo\*.cpp
</code></pre><p>のように記述すると、アスタリスク (<code>*</code>) をエスケープしようとして、<code>C:\foo*.cpp</code> というファイルを表すことになってしまいます。
この問題を避けるためには、Windows のディレクトリ・セパレータとして、Unix と同様にスラッシュ (<code>/</code>) を使用するようにします。</p><pre tabindex=0><code>C:/foo/*.cpp
</code></pre><h2 id=prerequisites-の検索パスを追加する-vpath-vpath>Prerequisites の検索パスを追加する (VPATH, vpath)</h2><h3 id=vpath-変数>VPATH 変数</h3><p>target や prerequisites の検索パスを追加したい時は、<strong><code>VPATH</code></strong> 変数にディレクトリのパスを設定します。
複数のパスを指定したい場合は、コロン (<code>:</code>) かスペースで区切って指定します（Windows の場合はセミコロン (<code>;</code>) で区切ります）。
カレントディレクトリはデフォルトで検索するので、指定する必要はありません。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>VPATH</span> <span class=o>=</span> src:../headers
</span></span></code></pre></div><p>上記のように設定すると、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>foo.o </span><span class=o>:</span> <span class=n>foo</span>.<span class=n>c</span>
</span></span></code></pre></div><p>というルールを処理するとき、カレントディレクトリで foo.c が見つからない場合、<code>src/foo.c</code> が検索され、さらに見つからない場合に <code>../headers/foo.c</code> が検索されるようになります。</p><h3 id=ファイルの種類ごとに検索パスを追加する-vpath-ディレクティブ>ファイルの種類ごとに検索パスを追加する vpath ディレクティブ</h3><p><code>vpath</code> ディレクティブを使用すると、ファイル名に応じて別々の検索パスを設定することができます。
例えば、</p><pre tabindex=0><code>vpath %.h   ../headers
vpath %.cpp src
vpath %     hoge
</code></pre><p>このようにすると、拡張子が <code>.h</code> のファイルの検索パスとして <code>../headers</code> ディレクトリが追加され、拡張子が <code>.cpp</code> のファイルの検索パスとして <code>src</code> ディレクトリが追加されます。
さらに、すべてのファイルの検索パスとして <code>hoge</code> ディレクトリが追加されます。</p><p>ディレクトリパスは <code>VPATH</code> の場合と同様に、コロンで区切って複数指定することができます。
検索の順序は <code>vpath</code> ディレクティブの呼び出し順序に従います。
例えば、</p><pre tabindex=0><code>vpath %.cpp foo:bar
vpath %.cpp hoge
</code></pre><p>と指定すると、<code>.cpp</code> ファイルが、カレントディレクトリ ⇒ <code>foo</code> ⇒ <code>bar</code> ⇒ <code>hoge</code> の順番で検索されます。</p><p>検索パスをクリアしたい場合は、ディレクトリパスを指定せずに <code>vpath</code> ディレクティブを呼び出します。</p><pre tabindex=0><code>vpath %       # すべてのファイルの検索パスを削除
vpath %.cpp   # .cpp ファイルの検索パスを削除
</code></pre><h2 id=prerequisites-で指定したファイルを-command-行で参照するマクロ-->prerequisites で指定したファイルを command 行で参照するマクロ ($^, $&lt;)</h2><p>command 行で <strong><code>$^</code></strong> を使用すると、prerequisites で指定したすべてのファイル名に展開されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>app </span><span class=o>:</span> <span class=n>a</span>.<span class=n>cpp</span> <span class=n>b</span>.<span class=n>cpp</span> <span class=n>c</span>.<span class=n>cpp</span>
</span></span><span class=line><span class=cl>	g++ <span class=k>$(</span>CXXFLAGS<span class=k>)</span> $^ -o <span class=nv>$@</span>
</span></span></code></pre></div><p>上記のように記載すると、下記のように展開されます。</p><ul><li><strong><code>$^</code></strong> ⇒ <code>a.cpp b.cpp c.cpp</code></li><li><strong><code>$@</code></strong> ⇒ <code>app</code></li></ul><p>command 行で <strong><code>$&lt;</code></strong> を使用すると、prerequisites で指定した最初のファイル名に展開されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>foo.o </span><span class=o>:</span> <span class=n>foo</span>.<span class=n>cpp</span> <span class=n>foo</span>.<span class=n>h</span> <span class=n>defs</span>.<span class=n>h</span>
</span></span><span class=line><span class=cl>	g++ -c <span class=k>$(</span>CXXFLAGS<span class=k>)</span> $&lt; -o <span class=nv>$@</span>
</span></span></code></pre></div><ul><li><strong><code>$&lt;</code></strong> ⇒ <code>foo.cpp</code></li><li><strong><code>$@</code></strong> ⇒ <code>foo.o</code></li></ul><p><code>$^</code> の <code>^</code> という記号が上を指す矢印、<code>$&lt;</code> の <code>&lt;</code> という記号が左を指す矢印だと考えると覚えやすいです。</p><h2 id=リンクライブラリの検索パス>リンクライブラリの検索パス</h2><p>prerequisistes に <code>-l&lt;name></code> という形式でリンクライブラリを指定しておくと、<code>lib&lt;name>.so</code>、あるいは <code>lib&lt;name>.a</code> が検索されます。
例えば、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>foo </span><span class=o>:</span> <span class=n>foo</span>.<span class=n>c</span> -<span class=n>lcurses</span>
</span></span><span class=line><span class=cl>	cc $^ -o <span class=nv>$@</span>
</span></span></code></pre></div><p>とすると、以下の順番で <code>libcurses.so</code> ファイルが検索されます。</p><ol><li>カレントディレクトリ</li><li><code>vpath</code> に設定したディレクトリ</li><li><code>VPATH</code> に設定したディレクトリ</li><li><code>/lib</code></li><li><code>/usr/lib</code></li><li><code>&lt;prefix>/lib</code> （通常は <code>/usr/local/lib</code>）</li></ol><p><code>libcurses.so</code> ファイルが見つからなかった場合は、上記の順で <code>libcurses.a</code> ファイルが検索されます。</p><p>prerequisites に <code>-l&lt;name></code> と指定した場合に、どんな名前のファイルを検索するかは、<strong><code>.LIBPATTERNS</code></strong> 変数に設定されたパターンによって決められます。
デフォルトでは次のような値に設定されています。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>.LIBPATTERNS</span> <span class=o>=</span> lib%.so lib%.a
</span></span></code></pre></div><p>よって、<code>-lcurses</code> と指定したときに、<code>libcurses.so</code> と <code>libcurses.a</code> ファイルが検索されることになります。</p><h2 id=phony-ターゲットの役割>.PHONY ターゲットの役割</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	rm *.o temp
</span></span></code></pre></div><p>というルールが設定されているとき、通常は</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make clean
</span></span></code></pre></div><p>と実行すると、<code>rm</code> コマンドが実行されます。
ただし、上記のルールは、基本的には <code>clean</code> というファイルを作成するためのルールとみなされるので、カレントディレクトリに <code>clean</code> というファイルが存在する場合は <code>rm</code> コマンドが実行されなくなってしまいます。</p><p>カレントディレクトリに <code>clean</code> というファイルが存在する場合でも <code>rm</code> コマンドを実行するようにするには、<strong><code>.PHONY</code></strong> ターゲットの prerequisites に <code>clean</code> を指定するようにします。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>clean</span>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	rm *.o temp
</span></span></code></pre></div><p><code>.PHONY</code> ターゲットに記述しておくことで、ファイル検索にかかる時間を省略できるというメリットもあります。
「ターゲット名＝ファイル名」でないときは、<code>.PHONY</code> ターゲットに指定しておくとよいです。</p><p><code>.PHONY</code> ターゲットが使用できない make 実装の場合は、空のターゲット <strong><code>FORCE</code></strong> を用意して以下のようにするのが慣例となっています。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span> <span class=n>FORCE</span>
</span></span><span class=line><span class=cl>	rm <span class=k>$(</span>OBJECTS<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nf>FORCE</span><span class=o>:</span>
</span></span></code></pre></div><h2 id=make-コマンドのパラメータで-make-変数を定義する>make コマンドのパラメータで make 変数を定義する</h2><p><code>make</code> コマンドを実行するときのパラメータで、make 変数を定義することができます。
次のサンプルは、<code>HOGE</code> という make 変数の値を、コマンドラインパラメータで指定する例です。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>HOGE</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo <span class=k>$(</span>HOGE<span class=k>)</span>
</span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make <span class=nv>HOGE</span><span class=o>=</span>aaa
</span></span><span class=line><span class=cl><span class=go>aaa
</span></span></span></code></pre></div></div></figure><p><code>Makefile</code> 内で定義された変数の値は、<code>make</code> コマンドのパラメータで上書きされます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>HOGE</span><span class=o>=</span><span class=m>100</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo <span class=k>$(</span>HOGE<span class=k>)</span>
</span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>100
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> make <span class=nv>HOGE</span><span class=o>=</span><span class=m>200</span>
</span></span><span class=line><span class=cl><span class=go>200
</span></span></span></code></pre></div></div></figure><h2 id=static-pattern-rules-target-名から-prerequisites-を自動構成するためのルール>Static Pattern Rules: target 名から prerequisites を自動構成するためのルール</h2><h3 id=static-pattern-rules-の構文>Static Pattern Rules の構文</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>targets ...</span><span class=o>:</span> <span class=n>target</span>-<span class=n>pattern</span>: <span class=n>prereq</span>-<span class=n>patterns</span> ...
</span></span><span class=line><span class=cl>	commands
</span></span><span class=line><span class=cl>       ...
</span></span></code></pre></div><p>targets では、通常のルールと同様にワイルドカードを使用することができます。
target-pattern には、一つの <code>%</code> を含めることができ、targets に指定したファイル名の一部にマッチするように指定します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Static Pattern Rules の例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>OBJECTS</span> <span class=o>=</span> foo.o bar.o
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=k>$(</span><span class=nv>OBJECTS</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(OBJECTS)</span><span class=o>:</span> %.<span class=n>o</span>: %.<span class=n>c</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>CC<span class=k>)</span> -c <span class=k>$(</span>CFLAGS<span class=k>)</span> $&lt; -o <span class=nv>$@</span>
</span></span></code></pre></div></div></figure><p>上記の例では、<code>foo.o</code> がターゲットになったとき、target-pattern の <code>%.o</code> に一致します。
この場合 <code>%</code> に一致する部分文字列は <code>foo</code> であり、自動的に <code>foo.c</code> という prerequisite が構成されます。
この <code>%</code> に一致した部分文字列のことを <strong>stem</strong> と呼びます。</p><p>この Static Pattern Rule により、自動的に以下のような <code>foo.o</code>、<code>bar.o</code> の構築ルールが生成されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>foo.o</span><span class=o>:</span> <span class=n>foo</span>.<span class=n>c</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>CC<span class=k>)</span> -c <span class=k>$(</span>CFLAGS<span class=k>)</span> foo.c -o foo.o
</span></span><span class=line><span class=cl><span class=nf>bar.o</span><span class=o>:</span> <span class=n>bar</span>.<span class=n>c</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>CC<span class=k>)</span> -c <span class=k>$(</span>CFLAGS<span class=k>)</span> bar.c -o bar.o
</span></span></code></pre></div><h3 id=static-pattern-rules-の-command-で-stem-を参照する>Static Pattern Rules の command で stem を参照する</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>bigoutput littleoutput</span><span class=o>:</span> %<span class=n>output</span>: <span class=n>text</span>.<span class=n>g</span>
</span></span><span class=line><span class=cl>	generate text.g -<span class=nv>$*</span> &gt; <span class=nv>$@</span>
</span></span></code></pre></div><p>command 行で stem（<code>%</code> に一致した部分文字列）を参照するには <code>$*</code> を使用します。
上記の Static Pattern Rule では、<code>$*</code> の部分に <code>big</code>, <code>little</code> という文字列が展開されるので、結果として以下のように解釈されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>bigoutput</span><span class=o>:</span> <span class=n>text</span>.<span class=n>g</span>
</span></span><span class=line><span class=cl>	generate text.g -big &gt; bigoutput
</span></span><span class=line><span class=cl><span class=nf>littleoutput</span><span class=o>:</span> <span class=n>text</span>.<span class=n>g</span>
</span></span><span class=line><span class=cl>	generate text.g -little &gt; littleoutput
</span></span></code></pre></div><h2 id=command-行のあれこれ>command 行のあれこれ</h2><h3 id=コマンド行の解釈に使用されるシェル>コマンド行の解釈に使用されるシェル</h3><p>コマンドの解釈はデフォルトでは <code>/bin/sh</code> が使用されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo <span class=nv>$$</span>SHELL    <span class=c1># shell 変数</span>
</span></span><span class=line><span class=cl>	@echo <span class=k>$(</span>SHELL<span class=k>)</span>   <span class=c1># make 変数</span>
</span></span></code></pre></div><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>/bin/sh
</span></span></span><span class=line><span class=cl><span class=go>/bin/sh
</span></span></span></code></pre></div></div></figure><p>コマンドの解釈に使用するシェルを変更するには、make 変数の <code>SHELL</code> を設定します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>SHELL</span> <span class=o>=</span> /bin/bash
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo <span class=nv>$$</span>SHELL    <span class=c1># shell 変数</span>
</span></span><span class=line><span class=cl>	@echo <span class=k>$(</span>SHELL<span class=k>)</span>   <span class=c1># make 変数</span>
</span></span></code></pre></div><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>/bin/bash
</span></span></span><span class=line><span class=cl><span class=go>/bin/bash
</span></span></span></code></pre></div></div></figure><h3 id=ms-dos-windows-の場合の-make-変数-shell-の解釈について>MS-DOS, Windows の場合の make 変数 SHELL の解釈について</h3><p>MS-DOS, Windows 版の <code>make</code> ではデフォルトのシェルとして <strong><code>COMSPEC</code></strong> 環境変数に設定されているものが使用されます。
<code>SHELL</code> 変数に Unix 形式のパスでシェルを指定すると、以下のようにシェルの実行ファイルが検索されます。</p><ol><li>指定されたパス通りのファイル（<code>SHELL = /bin/sh</code> とした場合、カレントドライブが <code>C:</code> の場合は <code>C:\bin\sh</code>）</li><li>カレントディレクトリのファイル</li><li><code>PATH</code> 環境変数に指定されたディレクトリにあるファイル</li></ol><p>完全にファイル名が一致するファイルがない場合、実行可能な形式のファイルが検索されます（<code>.exe</code>, <code>.com</code>, <code>.bat</code>, <code>.btm</code>, <code>.sh</code>）。
以上のようなルールにより、<code>SHELL = /bin/sh</code> と指定しておけば、<code>PATH</code> の通ったディレクトリに、<code>sh.exe</code> があればそれが使用されます。</p><h3 id=command-行間の空白行コメントについて>command 行間の空白行、コメントについて</h3><p>2 つのコマンド行の間の空白行や、make のコメント行は無視されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo <span class=m>100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	@echo <span class=m>200</span>
</span></span><span class=line><span class=cl><span class=c># Comment for make.
</span></span></span><span class=line><span class=cl><span class=c></span>	@echo <span class=m>300</span>
</span></span></code></pre></div><p>上記の <code>Makefile</code> を使って <code>make</code> コマンドを実行すると、以下のように表示されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>100
</span></span></span><span class=line><span class=cl><span class=go>200
</span></span></span><span class=line><span class=cl><span class=go>300
</span></span></span></code></pre></div><p>行頭がタブ文字で始まっている場合は、その後ろが空白であったとしても、必ずシェルによって処理されます。
例えば、</p><pre tabindex=0><code>all:
	@echo 100
[TAB]
	@echo 200
	# Comment for shell.
	@echo 300
</code></pre><p>とすると、シェルに空白行と、コメント行が渡されることになります。
ただし、<code>/bin/sh</code> は渡された空白行とコメント行を無視するので、実際には何も実行されていないかのように見え、先の例と結果は同じになります。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>100
</span></span></span><span class=line><span class=cl><span class=go>200
</span></span></span><span class=line><span class=cl><span class=go>300
</span></span></span></code></pre></div><h3 id=コマンド行での-make-変数の展開について>コマンド行での make 変数の展開について</h3><p>コマンド行の変数は <code>Makefile</code> を全て読んだ後に展開されます。
ただし、リビルド対象となったターゲットのコマンドに出てくる変数のみ展開されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>HOGE</span> <span class=o>=</span> aaa
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo <span class=k>$(</span>HOGE<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>HOGE</span> <span class=o>=</span> bbb
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>bbb
</span></span></span></code></pre></div><h3 id=コマンド行でのシェル変数の展開について>コマンド行でのシェル変数の展開について</h3><p>コマンド行でシェル変数を使用するときは、make 変数を参照するときの <code>$</code> 記号と区別するために、変数名の前に <code>$$</code> を付けるようにします（<code>$$</code> を２つ並べることで、<code>$</code> がエスケープ処理されて、シェルコマンド本来の <code>$</code> 記号の振る舞いをするようになります）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>LIST</span> <span class=o>=</span> one two three
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> i in <span class=k>$(</span>LIST<span class=k>)</span><span class=p>;</span> <span class=k>do</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>         <span class=nb>echo</span> <span class=nv>$$</span>i<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	<span class=k>done</span>
</span></span></code></pre></div><p>command 行は各行ごとにサブシェルで実行されるので、上記のような for ループは、必ずバックスラッシュ (<code>\</code>) で各行を連結させる必要があります。</p><h3 id=コマンド行は各行ごとにサブシェルで実行される>コマンド行は各行ごとにサブシェルで実行される</h3><p>コマンド行は各行ごとにサブシェルか起動されて実行されます。
たとえ <code>cd</code> コマンドでカレントディレクトリを変更したとしても、次のコマンド行にはそのカレントディレクトリを引き継ぐことができません。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=nb>cd</span> hoge
</span></span><span class=line><span class=cl>	<span class=nb>pwd</span>       <span class=c1># hoge ディレクトリではない</span>
</span></span></code></pre></div><p>この問題に対処するには、<code>&&</code> 演算子でコマンドを繋いでひとつのコマンド行にまとめてやる必要があります。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=nb>cd</span> hoge <span class=o>&amp;&amp;</span> <span class=nb>pwd</span>    <span class=c1># pwd コマンドは hoge ディレクトリで実行される</span>
</span></span></code></pre></div><p>注）MS-DOS ではカレントディレクトリがグローバルに保持されるため、上記のようにコマンドをまとめなくても <code>cd</code> コマンドの結果が次のコマンド行にも反映されます。</p><h3 id=コマンドの実行でエラーが出ても処理を継続する>コマンドの実行でエラーが出ても処理を継続する</h3><p>command の実行でエラー（終了ステータスが 0 以外）が発生した場合、make はそれ以降の command を実行しないで終了します。
command の実行でエラーが発生しても処理を継続するには、command の前に <code>-</code> を付けます（この <code>-</code> はシェルに command 行が渡される時に削除されます）。</p><p>例えば、<code>mkdir</code> コマンドは、既にディレクトリが存在する場合にはエラーで終了しますが、このエラーによって make の処理を終了しないようにするには以下のように記述します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	-mkdir hoge
</span></span><span class=line><span class=cl>	@echo Hello
</span></span></code></pre></div><p><code>rm</code> コマンドなども同様です。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	-rm -f *.o
</span></span></code></pre></div><p>すべてのコマンドのエラーを無視するようにするには、<code>make</code> を実行するときのパラメータに <code>-i</code> (<code>--ignore-erros</code>) を指定するか、スペシャルターゲットの <code>.IGNORE</code> を prerequisites を指定せずに <code>Makefile</code> の中に記述します。
ただし、それぞれのコマンドの振る舞いを明確にするために <code>-</code> を使うことが推奨されています。</p><p>複数の prerequisites を処理している最中に、command の実行エラーが発生した場合に、残りの prerequisites の target の処理を継続させるには <code>-k</code> (<code>--keep-going</code>) オプションを指定して <code>make</code> を実行します。</p><h2 id=再帰-make-recursive-make>再帰 make (recursive make)</h2><h3 id=再起-make-とは>再起 make とは</h3><p>コマンド行で <code>make</code> コマンドを実行することで、再帰的に <code>make</code> を実行することができます。
例えば、大きなプロジェクトでは、ディレクトリごとに <code>Makefile</code> を置き、サブシステムごとのビルド方法を定義します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>subsystem</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=nb>cd</span> subdir <span class=o>&amp;&amp;</span> <span class=k>$(</span>MAKE<span class=k>)</span>
</span></span></code></pre></div><p>あるいは</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>subsystem</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>MAKE<span class=k>)</span> -C subdir
</span></span></code></pre></div><p><code>MAKE</code> 変数は、トップレベルの <code>Makefile</code> を読み出した <code>make</code> のパスに置き換えられます。</p><p><code>make</code> コマンドを <code>-t</code> (<code>--touch</code>) オプションを付けて起動した場合は、通常 command 行は処理されませんが、command 行に、上記のように <code>$(MAKE)</code> が含まれている場合、例外として command 行が処理されることになっています。
この例外的処理のおかげで、<code>make -t</code> を実行した場合でも、再帰的な <code>make</code> 呼び出しを正しく実行することができます。
ちなみに、<code>$(MAKE)</code> のない command 行でも、先頭に <code>+</code> 記号を付けることで処理のスキップを避けることができます。</p><p>つまり、再帰 make において、<code>make</code> コマンドを実行するときは、以下のような理由で <code>$(MAKE)</code> を指定するべきだと言えます。</p><ul><li>すべての make 処理で同一の <code>make</code> コマンドを利用できる（トップレベルで起動した <code>make</code>）。</li><li><code>make</code> のオプションで <code>-t</code>、<code>-n</code>、<code>-q</code> を指定した場合にも、再帰 make 呼び出しを正しく実行することができる。</li></ul><h3 id=再帰-make-で-sub-make-に変数の値を渡す>再帰 make で sub-make に変数の値を渡す</h3><p>デフォルトでは、呼び出し側の <code>Makefile</code> で定義した変数の値は、sub-make 側に渡されません。
sub-make に対して変数の値を公開するには、<code>export</code> ディレクティブを使用します（各 command への <code>export</code> ではなく、あくまで sub-make への <code>export</code> です）。</p><pre tabindex=0><code>export &lt;variable&gt; ...
</code></pre><p><code>export</code> ディレクティブでは、値の代入を同時に行うことができます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=k>export </span><span class=nv>HOGE</span> <span class=o>=</span> <span class=m>100</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>MAKE<span class=k>)</span> -f sub.mk
</span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>sub.mk</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo <span class=k>$(</span>HOGE<span class=k>)</span>
</span></span></code></pre></div></div></figure><p><code>export</code> の処理は、変数の定義と同様に <code>Makefile</code> の呼び出し時に行われます。
よって、command 行よりも後ろに <code>export</code> が記述されている場合も、その定義は有効になります。</p><p>すべての変数を sub-make 側に渡すには、パラメータなしで <code>export</code> を実行します。
このとき、特定の変数の内容だけ渡さないようにするには <code>unexport</code> ディレクティブを使用します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=k>export</span>
</span></span><span class=line><span class=cl><span class=nv>unexport</span> <span class=nv>FOO</span> <span class=nv>BAR</span>
</span></span></code></pre></div><p><code>make</code> 実行時に、コマンドライン・パラメータとして指定した変数は、デフォルトで sub-make にも引き渡されます。
これらのパラメータは、内部的に <code>MAKEFLAGS</code> という変数に保持されています。
例えば、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make -k <span class=nv>HOGE</span><span class=o>=</span><span class=m>100</span>
</span></span></code></pre></div><p>のように実行すると、<code>$(MAKEFLAGS)</code> の値は <code>k -- HOGE=100</code> のような感じで、make が内部的に理解しやすい形に変換されて保持されます。
オプションの性質上、<code>MAKEFLAGS</code> 変数に保持されないパラメータもあります（<code>-C</code>、<code>-f</code>、<code>-o</code>、<code>-W</code> など）。</p><p>sub-make に対して、コマンドライン・パラメータを渡さないようにするには、以下のように <code>MAKEFLAGS</code> の値を空にします。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>subsystem</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=nb>cd</span> subdir <span class=o>&amp;&amp;</span> <span class=k>$(</span>MAKE<span class=k>)</span> <span class=nv>MAKEFLAGS</span><span class=o>=</span>
</span></span></code></pre></div><p>似たような変数に、コマンドラインで指定したオプションのみを参照する <code>MFLAGS</code> 変数や、コマンドラインで指定した変数定義のみを参照する <code>MAKEOVERRIDES</code> 変数などがありますが、これらは互換性のために残されており、<code>MAKEFLAGS</code> 変数の使用が推奨されています。
<code>Makefile</code> の中で、<code>MAKEFLAGS</code> 変数にオプションを追加して make の振る舞いを変更することもできますが、大きく動作が変わるようなオプションを指定することは避けるべきです。</p><h3 id=top-level-の-make-か-sub-make-かを調べる>top-level の make か sub-make かを調べる</h3><p>再帰 make において、何階層目の sub-make かを調べたいときは、<code>MAKELEVEL</code> 変数を参照します。
トップレベルの make では、この値は 0 になります。</p><pre tabindex=0><code>all:
ifeq ($(MAKELEVEL), 0)
	@echo top-level make.
else
	@echo not top-level make.
endif
</code></pre><h2 id=複数の-command-呼び出しをまとめて使いまわす-canned-command-sequences>複数の command 呼び出しをまとめて使いまわす (Canned Command Sequences)</h2><p><code>define - endef</code> ディレクティブを使用すると、複数のコマンド呼び出しをひとつにまとめることができます (Canned Command Sequence)。</p><p>ここで定義する command 行は、TAB 文字で初まっている必要はありません。
command 行の中で使用した変数は、実際に command が実行されるときに展開されます。
定義した Canned Command Sequence は、複数のターゲットで使いまわすことができます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>define greet-and-print-target
</span></span><span class=line><span class=cl>  echo Hello.
</span></span><span class=line><span class=cl>  @echo Target is $@.
</span></span><span class=line><span class=cl>endef
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>all:
</span></span><span class=line><span class=cl>	$(greet-and-print-target)</span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>echo Hello.
</span></span></span><span class=line><span class=cl><span class=go>Hello.
</span></span></span><span class=line><span class=cl><span class=go>Target is all.
</span></span></span></code></pre></div></div></figure><p>Canned Command Sequence の呼び出し時に、<code>@</code> などのプレフィックスを付けた場合、すべての command 行にプレフィックスを付けた場合と同様の効果が現れます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@<span class=o>(</span><span class=nv>$greet</span>-and-print-target<span class=o>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>Hello.
</span></span></span><span class=line><span class=cl><span class=go>Target is all.
</span></span></span></code></pre></div><h2 id=makefile-内での条件分岐-condtional-parts>Makefile 内での条件分岐 (Condtional Parts)</h2><p><code>Makefile</code> の中で <strong><code>ifeq</code></strong> ディレクティブや <strong><code>ifneq</code></strong> ディレクティブを使用すると、変数同士の比較や、変数と文字列の比較を行って処理を分岐させることができます。</p><pre tabindex=0><code>HOGE = aaa

all:
ifeq ($(HOGE), aaa)
	@echo matched.
else
	@echo not matched.
endif
</code></pre><p>これらの条件分岐は、もちろん command 行以外でも使用できます。</p><pre tabindex=0><code>ifeq ($(DEBUG), 1)
  LIBS = $(LIBS_FOR_DEBUG)
else
  LIBS = $(LIBS_FOR_RELEASE)
endif
</code></pre><p>上記の例では、変数定義部で分かりやすいようにインデントしています。
command 行以外でのインデントには、<strong>TAB 文字ではなく、半角スペースを使う</strong> ようにしてください。
TAB 文字を使用すると、command 行だとみなされてしまいます。</p><p><code>ifeq</code> の構文としては、下記のいずれかを使用することができます。</p><pre tabindex=0><code>ifeq (arg1, arg2)
ifeq &#39;arg1&#39; &#39;arg2&#39;
ifeq &#34;arg1&#34; &#34;arg2&#34;
ifeq &#39;arg1&#39; &#34;arg2&#34;
ifeq &#34;arg2&#34; &#39;arg2&#39;
</code></pre><p><code>ifeq</code> の代わりに、<strong><code>ifneq</code></strong> を使用すると、2 つの引数が一致していないことを調べることができます。</p><pre tabindex=0><code>ifneq ($(HOGE), aaa)
	@echo Not matched.
else
	@echo Matched.
endif
</code></pre><p>変数の内容が空かどうかを調べるには以下のようにします。
この例では、<code>strip</code> 関数により、空白文字を削除してから変数の値が空かどうかをチェックしています。</p><pre tabindex=0><code>ifeq ($(strip $(HOGE)),)
	@echo Empty.
else
	@echo Not empty.
endif
</code></pre><p>条件チェックは <code>Makefile</code> を読み込むときに行うので、変数の定義のタイミングによって動作が変化します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>HOGE = 1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>all:
</span></span><span class=line><span class=cl>ifeq ($(HOGE), 1)
</span></span><span class=line><span class=cl>	@echo Hoge is one.
</span></span><span class=line><span class=cl>endif
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>HOGE = 2</span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>Hoge is one.
</span></span></span></code></pre></div></div></figure><h3 id=条件文での-or-や-and>条件文での OR や AND</h3><p>バージョン 3.81（2006/04 リリース）からは、AND 条件や OR 条件を表現するための、<strong><code>$(and)</code></strong> や <strong><code>$(or)</code></strong> が使えるようになったようです。
それ以前のバージョンだと、<code>ifeq</code> や <code>ifdef</code> をネストしてがんばります。</p><ul><li>参考: <a href=https://bopperjp.hatenablog.com/entries/2006/09/03>2006-09-03 - bopperjp の日記</a></li></ul><p>GNU Make document (Ver. 3.81) を読むと、</p><pre tabindex=0><code>条件
  ...
else 条件
  ...
else
  ...
endif
</code></pre><p>のように <code>else if</code> できるように書いてありますが、少なくとも Ver. 3.79.1 ではうまく動きませんでした。
<code>else</code> の後ろにさらに条件を書こうとすると、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>Makefile:5: Extraneous text after `else&#39; directive
</span></span></span><span class=line><span class=cl><span class=go>Makefile:7: *** only one `else&#39; per conditional.  Stop.
</span></span></span></code></pre></div><p>みたいなエラーになってしまいます。</p><h2 id=変数の詳細>変数の詳細</h2><h3 id=基本>基本</h3><p>GNU make 以外の make では、変数のことをマクロと呼んでいるものもあります。
変数の値を参照するときは、<strong><code>$(foo)</code></strong> あるいは、<strong><code>${foo}</code></strong> のように記述します。
変数展開は <code>Makefile</code> の読み込み時に行われますが、command 行に記述された変数は、command が実行される段階で展開されます。</p><p>変数名は C 言語と同様、大文字／小文字が区別されます。
変数名は伝統的に大文字だけで構成されることが多いのですが、GNU make のマニュアルでは、ユーザ定義の変数は小文字だけで構成することを推奨しています。これは、implicit rule で使用される変数や、コマンドのオプションを定義するために用意されている変数と区別しやすくするためです。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>例: 変数のデフォルト値を確認してみる</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>all</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo <span class=nv>CC</span> <span class=o>=</span> <span class=k>$(</span>CC<span class=k>)</span>
</span></span><span class=line><span class=cl>	@echo <span class=nv>CFLAGS</span> <span class=o>=</span> <span class=k>$(</span>CFLAGS<span class=k>)</span>
</span></span><span class=line><span class=cl>	@echo <span class=nv>CXX</span> <span class=o>=</span> <span class=k>$(</span>CXX<span class=k>)</span>
</span></span><span class=line><span class=cl>	@echo <span class=nv>CXXFLAGS</span> <span class=o>=</span> <span class=k>$(</span>CXXFLAGS<span class=k>)</span>
</span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>CC = cc
</span></span></span><span class=line><span class=cl><span class=go>CFLAGS =
</span></span></span><span class=line><span class=cl><span class=go>CXX = g++
</span></span></span><span class=line><span class=cl><span class=go>CXXFLAGS =
</span></span></span></code></pre></div></div></figure><h3 id=変数の定義>変数の定義</h3><p>変数を定義するときに他の変数の値を参照する場合、その展開方法が大きく分けて２種類あります。
展開方法は変数代入時に使用する演算子などで決定されます。</p><p>1 つ目の展開方法は、<strong>Recursively expanded variable（再帰展開変数）</strong> です。
<code>=</code> 演算子や、<code>define</code> を使って変数を定義する場合、右辺の変数は再帰的に展開が行われます。
つまり、<code>Makefile</code> を最後まで処理して、右辺の変数の値が最終的にどのような値になるかが決定されます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>a</span> <span class=o>=</span> <span class=k>$(</span>b<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>b</span> <span class=o>=</span> <span class=k>$(</span>c<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>c</span> <span class=o>=</span> foo
</span></span><span class=line><span class=cl><span class=nv>c</span> <span class=o>=</span> bar
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>; @<span class=n>echo</span> <span class=k>$(</span><span class=nv>a</span><span class=k>)</span></span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>bar
</span></span></span></code></pre></div></div></figure><p>変数が再帰的に展開されるため、次のように自分自身を参照しようとするとエラーになります。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>a</span> <span class=o>=</span> foo
</span></span><span class=line><span class=cl><span class=nv>a</span> <span class=o>=</span> <span class=k>$(</span>a<span class=k>)</span> bar
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>; @<span class=n>echo</span> <span class=k>$(</span><span class=nv>a</span><span class=k>)</span></span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>Makefile:4: *** Recursive variable `a&#39; references itself (eventually).  Stop.
</span></span></span></code></pre></div></div></figure><p>2 つ目の展開方法は、<strong>Simply expanded variables（単純展開変数）</strong> です。
<code>:=</code> 演算子を使用して変数を定義すると、代入時に格納されている値が、参照結果として使用されます。
一般的な手続き型のプログラム言語の変数定義ような感覚で使用することができます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>a</span> <span class=o>:=</span> foo
</span></span><span class=line><span class=cl><span class=nv>b</span> <span class=o>:=</span> <span class=k>$(</span>a<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>a</span> <span class=o>:=</span> bar
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>; @<span class=n>echo</span> <span class=k>$(</span><span class=nv>b</span><span class=k>)</span></span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>foo
</span></span></span></code></pre></div></div></figure><p>当然、まだ定義されていない変数を参照すると、その中身は空っぽです。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>a</span> <span class=o>:=</span> <span class=k>$(</span>b<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>; @<span class=n>echo</span> <span class=k>$(</span><span class=nv>a</span><span class=k>)</span></span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span></code></pre></div></div></figure><h3 id=変数が未定義のときのみ定義する-conditional-variable-assignment->変数が未定義のときのみ定義する Conditional variable assignment (?=)</h3><p><strong><code>?=</code></strong> 演算子を使うと、その変数がまだ未定義のときのみ値を代入（定義）することができます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>例1: 変数がすでに定義されているケース</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>a</span> <span class=o>=</span> <span class=m>100</span>
</span></span><span class=line><span class=cl><span class=nv>a</span> <span class=o>?=</span> <span class=m>200</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>; @<span class=n>echo</span> <span class=k>$(</span><span class=nv>a</span><span class=k>)</span></span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>100
</span></span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>例2: 変数が未定義のケース</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>a</span> <span class=o>?=</span> <span class=m>200</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>; @<span class=n>echo</span> <span class=k>$(</span><span class=nv>a</span><span class=k>)</span></span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>200
</span></span></span></code></pre></div></div></figure><p><code>?=</code> による代入は、以下のような条件文と同様の効果を持ちます。</p><pre tabindex=0><code>ifeq ($(origin FOO), undefined)
  FOO = bar
endif
</code></pre><p>変数に空文字が代入されている時は、その変数は未定義であるとはみなされません。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>a</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>a</span> <span class=o>?=</span> <span class=m>100</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>; @<span class=n>echo</span> <span class=k>$(</span><span class=nv>a</span><span class=k>)</span></span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>100
</span></span></span></code></pre></div></div></figure><h3 id=変数のサフィックスを置換して展開する-substitution-references>変数のサフィックスを置換して展開する (Substitution References)</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>$(var</span><span class=o>:</span><span class=n>aaa</span>=<span class=n>bbb</span>)
</span></span></code></pre></div><p>という書式で変数を参照すると、変数中の文字列の <code>aaa</code> が <code>bbb</code> に置換されて展開されます。
ただし、変換されるのは、文字列の末尾、あるいは空白文字の直前の <code>aaa</code> だけです。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>foo</span> <span class=o>:=</span> a.o b.o c.o.o
</span></span><span class=line><span class=cl><span class=nv>bar</span> <span class=o>:=</span> <span class=k>$(</span>foo:.o<span class=o>=</span>.c<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>; @<span class=n>echo</span> <span class=k>$(</span><span class=nv>bar</span><span class=k>)</span></span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>a.c b.c c.o.c
</span></span></span></code></pre></div></div></figure><p><code>c.o.o</code> の末尾の <code>.o</code> だけが <code>.c</code> に変換されているところに注目です。</p><h3 id=変数の値の最後の空白は-strip-されない>変数の値の最後の空白は strip されない</h3><p>変数を <code>=</code> や <code>:=</code> で定義するとき、<code>=</code> の直後の空白は無視されますが、行末の空白スペースは変数の値として格納されます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>hoge</span> <span class=o>=</span> aaa   <span class=c1># 3 spaces</span>
</span></span></code></pre></div><p>とすると、<code>$(hoge)</code> の値は、<code>aaa___</code>（<code>_</code>はスペース）となります。
行末に意図的にスペースを入れたい場合は、上記のように行末にコメントを入れることで、見た目でスペースがあることを判断できるようになります。</p><h3 id=変数の値を追加する場合は--演算子を使うべし>変数の値を追加する場合は += 演算子を使うべし</h3><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>hoge</span> <span class=o>=</span> aaa bbb
</span></span><span class=line><span class=cl><span class=nv>hoge</span> <span class=o>+=</span> ccc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo <span class=k>$(</span>hoge<span class=k>)</span>
</span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>aaa bbb ccc
</span></span></span></code></pre></div></div></figure><p>上記のように <code>+=</code> 演算子を使用すると、現在の変数の値を追加することができます。
追加する値の前には、１つのスペースが入ります。</p><p><code>+=</code> 演算子で値を追加しようとした場合に、その変数がまだ定義されていない場合は、<code>=</code> 演算子を使ったのと同じ振る舞いをします。</p><p>Simply expand の行われる <code>:=</code> 演算子を使い、以下のように変数の値にテキストを追加することもできます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>hoge</span> <span class=o>:=</span> aaa bbb
</span></span><span class=line><span class=cl><span class=nv>hoge</span> <span class=o>:=</span> <span class=k>$(</span>hoge<span class=k>)</span> ccc    ※ <span class=k>$(</span>hoge<span class=k>)</span> → <span class=s2>&#34;aaa bbb ccc&#34;</span>
</span></span></code></pre></div><p>ただし、このような自己参照によって値を追加する方法は、Recursive expand（再帰展開）の行われる <code>=</code> 演算子と組み合わせた場合に若干問題となることがあります。
例えば、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>CFLAGS</span> <span class=o>=</span> <span class=k>$(</span>includes<span class=k>)</span> -O
</span></span><span class=line><span class=cl><span class=nv>CFLAGS</span> <span class=o>:=</span> <span class=k>$(</span>CFLAGS<span class=k>)</span> -pg    ※<span class=o>(</span>1<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nv>includes</span> <span class=o>=</span> header
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=k>$(</span>CFLAGS<span class=k>)</span>    ※ <span class=k>$(</span>CFALGS<span class=k>)</span> → <span class=s2>&#34;-O -pg&#34;</span>
</span></span></code></pre></div><p>のようにすると、(1) の代入部分で <code>CFLAGS</code> の値を参照すると、<code>$(includes) -O</code> となっていますが、この時点で <code>CFLAGS</code> は Recursive expanded variable として定義されているので、まだ <code>$(includes)</code> の内容は空の状態です（Makefile を最後まで読まないと、Recursive expanded variable はちゃんと展開されない）。
にもかかわらず、<code>:=</code> 演算子を使った時点で Simply expand による展開（定義時の値決定）をしようとするため、最終的に <code>CFLAGS</code> 変数の値に <code>includes</code> 変数の値は含まれず、<code>-O -pg</code> となってしまいます。</p><p>このようなケースでは、以下のように <code>+=</code> 演算子を使用すれば、すべての代入が Recursive expand（再帰展開）されるので、意図通りの結果を得ることができます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>CFLAGS</span> <span class=o>=</span> <span class=k>$(</span>includes<span class=k>)</span> -O
</span></span><span class=line><span class=cl><span class=nv>CFLAGS</span> <span class=o>+=</span> -pg
</span></span><span class=line><span class=cl><span class=nv>includes</span> <span class=o>=</span> header
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=k>$(</span>CFLAGS<span class=k>)</span>    ※ <span class=k>$(</span>CFALGS<span class=k>)</span> → <span class=s2>&#34;header -O -pg&#34;</span>
</span></span></code></pre></div><h3 id=make-のコマンドラインパラメータで指定した値を上書きする>make のコマンドライン・パラメータで指定した値を上書きする</h3><p><code>make</code> のコマンドライン引数で変数値を指定すると、通常は <code>Makefile</code> 内での定義よりも優先されます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>hoge</span> <span class=o>=</span> <span class=m>100</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>; <span class=n>echo</span> <span class=k>$(</span><span class=nv>hoge</span><span class=k>)</span></span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make <span class=nv>hoge</span><span class=o>=</span><span class=m>200</span>
</span></span><span class=line><span class=cl><span class=go>200
</span></span></span></code></pre></div></div></figure><p>この優先度を変えて、<code>Makefile</code> 内の変数定義を有効にしたい場合は <code>override</code> ディレクティブを使用します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>override hoge = 100
</span></span><span class=line><span class=cl>all:; echo $(hoge)</span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make <span class=nv>hoge</span><span class=o>=</span><span class=m>200</span>
</span></span><span class=line><span class=cl><span class=go>100
</span></span></span></code></pre></div></div></figure><p>この優先度は、<code>+=</code> 演算子による値の追加でも同様で、コマンドライン引数で変数値が指定されていると、その変数への <code>+=</code> での追加は通常無視されます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nv>hoge</span> <span class=o>=</span> <span class=m>100</span>
</span></span><span class=line><span class=cl><span class=nv>hoge</span> <span class=o>+=</span> <span class=m>200</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>; <span class=n>echo</span> <span class=k>$(</span><span class=nv>hoge</span><span class=k>)</span></span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make <span class=nv>hoge</span><span class=o>=</span>aaa
</span></span><span class=line><span class=cl><span class=go>aaa
</span></span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Makefile</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>hoge = 100
</span></span><span class=line><span class=cl>override hoge += 200
</span></span><span class=line><span class=cl>all:; echo $(hoge)</span></span></code></pre></div></div></figure><figure class=xCodeBlock><figcaption class=xCodeBlock_title>実行結果</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> make <span class=nv>hoge</span><span class=o>=</span>aaa
</span></span><span class=line><span class=cl><span class=go>aaa 200
</span></span></span></code></pre></div></div></figure><h3 id=変数の優先順位>変数の優先順位</h3><p>変数定義の優先順位は、高い順に以下のようになっています。</p><ol><li><code>Makefile</code> 内の変数定義（<code>override</code> ディレクティブ付き）</li><li>コマンドライン引数で指定した変数定義</li><li><code>Makefile</code> 内の変数定義（<code>override</code> ディレクティブなし）</li><li>環境変数</li></ol><p>環境変数の優先度が低くなっているおかげで、make 以外の用途で設定した環境変数によって make の振る舞いを大きく変えてしまうような危険性を軽減しています。
例えば、make 内のコマンド解釈に使用するシェルを、<code>Makefile</code> 内の <code>SHELL</code> 変数定義で安心して変更することができます。</p><h3 id=ターゲット内だけで有効な変数を定義する-target-specific-variable>ターゲット内だけで有効な変数を定義する (Target-specific Variable)</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>target ... </span><span class=o>:</span> <span class=n>variable</span>-<span class=n>assignment</span>
</span></span></code></pre></div><p>上記のような構文で変数を定義すると、そのターゲット内でのみ有効な変数を定義することができます。
例えば、特定のターゲットでのみコマンドのオプションを変更したい場合などに有効です。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>prog</span><span class=o>:</span> <span class=n>CFLAGS</span> = -<span class=n>g</span>
</span></span><span class=line><span class=cl>	...
</span></span></code></pre></div></div></figure><p>Target-specific Variable は、そのターゲットの prerequisites の構築に対しても有効です。
例えば、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>prog</span><span class=o>:</span> <span class=n>CFLAGS</span> = -<span class=n>g</span>
</span></span><span class=line><span class=cl><span class=nf>prog</span><span class=o>:</span> <span class=n>prog</span>.<span class=n>o</span> <span class=n>foo</span>.<span class=n>o</span> <span class=n>bar</span>.<span class=n>o</span>
</span></span></code></pre></div><p>のようにすると、<code>CFLAGS</code> 変数は <code>prog.o</code>、<code>foo.o</code>、<code>bar.o</code> ターゲットの構築においても有効です。</p><p>ターゲットにパターンを使用した場合は、特に Pattern-specific Variable と呼びます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=nf>%.o</span><span class=o>:</span> <span class=n>CFLAGS</span> = -<span class=n>O</span></span></span></code></pre></div></div></figure></div><div class=article__footer><div class=article__date><time class=pageDate>2007-06-29</time></div><div style=text-align:right><div class=mm-snsButtons><a rel="nofollow noopener noreferrer" target=_blank href="https://twitter.com/intent/post?url=https%3a%2f%2fmaku77.github.io%2fp%2f3r6ds3r%2f"><span class=mm-snsButtons__icon><svg fill="#000" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932zM17.61 20.644h2.039L6.486 3.24H4.298z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://www.threads.net/intent/post?text=https%3a%2f%2fmaku77.github.io%2fp%2f3r6ds3r%2f" name=HOGE><span class=mm-snsButtons__icon><svg fill="#000" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Threads</title><path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18.0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.589 12c.027 3.086.718 5.496 2.057 7.164 1.43 1.783 3.631 2.698 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.31-.71-.873-1.3-1.634-1.75-.192 1.352-.622 2.446-1.284 3.272-.886 1.102-2.14 1.704-3.73 1.79-1.202.065-2.361-.218-3.259-.801-1.063-.689-1.685-1.74-1.752-2.964-.065-1.19.408-2.285 1.33-3.082.88-.76 2.119-1.207 3.583-1.291a13.853 13.853.0 013.02.142c-.126-.742-.375-1.332-.75-1.757-.513-.586-1.308-.883-2.359-.89h-.029c-.844.0-1.992.232-2.721 1.32L7.734 7.847c.98-1.454 2.568-2.256 4.478-2.256h.044c3.194.02 5.097 1.975 5.287 5.388.108.046.216.094.321.142 1.49.7 2.58 1.761 3.154 3.07.797 1.82.871 4.79-1.548 7.158-1.85 1.81-4.094 2.628-7.277 2.65zm1.003-11.69c-.242.0-.487.007-.739.021-1.836.103-2.98.946-2.916 2.143.067 1.256 1.452 1.839 2.784 1.767 1.224-.065 2.818-.543 3.086-3.71a10.5 10.5.0 00-2.215-.221z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://www.facebook.com/share.php?u=https%3a%2f%2fmaku77.github.io%2fp%2f3r6ds3r%2f"><span class=mm-snsButtons__icon><svg fill="#0866ff" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Facebook</title><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401.0.955.042 1.468.103a8.68 8.68.0 011.141.195v3.325a8.623 8.623.0 00-.653-.036 26.805 26.805.0 00-.733-.009c-.707.0-1.259.096-1.675.309a1.686 1.686.0 00-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://timeline.line.me/social-plugin/share?url=https%3a%2f%2fmaku77.github.io%2fp%2f3r6ds3r%2f&text=make%20%e3%82%92%e4%bd%bf%e3%81%84%e3%81%93%e3%81%aa%e3%81%99%e3%81%9f%e3%82%81%e3%81%ae%e3%83%a1%e3%83%a2%20-%20%e5%a4%a9%e6%89%8d%e3%81%be%e3%81%8f%e3%81%be%e3%81%8f%e3%83%8e%e3%83%bc%e3%83%88"><span class=mm-snsButtons__icon><svg fill="#00c300" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LINE</title><path d="M19.365 9.863c.349.0.63.285.63.631.0.345-.281.63-.63.63H17.61v1.125h1.755c.349.0.63.283.63.63.0.344-.281.629-.63.629h-2.386c-.345.0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346.0.627.285.627.63.0.349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211.0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346.0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195.0.375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345.0.63.285.63.63v4.771zm-5.741.0c0 .344-.282.629-.631.629-.345.0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346.0.628.285.628.63v4.771zm-2.466.629H4.917c-.345.0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348.0.63.285.63.63v4.141h1.756c.348.0.629.283.629.63.0.344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943.0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://b.hatena.ne.jp/entry?url=https%3a%2f%2fmaku77.github.io%2fp%2f3r6ds3r%2f"><span class=mm-snsButtons__icon><svg fill="#00a4de" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Hatena Bookmark</title><path d="M20.47.0C22.42.0 24 1.58 24 3.53v16.94c0 1.95-1.58 3.53-3.53 3.53H3.53C1.58 24 0 22.42.0 20.47V3.53C0 1.58 1.58.0 3.53.0h16.94zm-3.705 14.47c-.78.0-1.41.63-1.41 1.41s.63 1.414 1.41 1.414 1.41-.645 1.41-1.425-.63-1.41-1.41-1.41zM8.61 17.247c1.2.0 2.056-.042 2.58-.12.526-.084.976-.222 1.32-.412.45-.232.78-.564 1.02-.99s.36-.915.36-1.48c0-.78-.21-1.403-.63-1.87-.42-.48-.99-.734-1.74-.794.66-.18 1.156-.45 1.456-.81.315-.344.465-.824.465-1.424.0-.48-.103-.885-.3-1.26-.21-.36-.493-.645-.883-.87-.345-.195-.735-.315-1.215-.405-.464-.074-1.29-.12-2.474-.12H5.654v10.486H8.61zm.736-4.185c.705.0 1.185.088 1.44.262.27.18.39.495.39.93.0.405-.135.69-.42.855-.27.18-.765.254-1.44.254H8.31v-2.297h1.05zm8.656.706v-7.06h-2.46v7.06H18zM8.925 9.08c.71.0 1.185.08 1.432.24.245.16.367.435.367.83.0.38-.13.646-.39.804-.265.154-.747.232-1.452.232h-.57V9.08h.615z"/></svg></span></a><a rel="nofollow noopener noreferrer" target=_blank href="https://getpocket.com/edit?url=https%3a%2f%2fmaku77.github.io%2fp%2f3r6ds3r%2f&title=make%20%e3%82%92%e4%bd%bf%e3%81%84%e3%81%93%e3%81%aa%e3%81%99%e3%81%9f%e3%82%81%e3%81%ae%e3%83%a1%e3%83%a2%20-%20%e5%a4%a9%e6%89%8d%e3%81%be%e3%81%8f%e3%81%be%e3%81%8f%e3%83%8e%e3%83%bc%e3%83%88"><span class=mm-snsButtons__icon><svg fill="#ef3f56" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Pocket</title><path d="M18.813 10.259l-5.646 5.419c-.32.305-.73.458-1.141.458-.41.0-.821-.153-1.141-.458l-5.646-5.419c-.657-.628-.677-1.671-.049-2.326.63-.657 1.671-.679 2.325-.05l4.511 4.322 4.517-4.322c.66-.631 1.697-.607 2.326.049.631.645.615 1.695-.045 2.326l-.011.001zm5.083-7.546c-.299-.858-1.125-1.436-2.041-1.436H2.179c-.9.0-1.717.564-2.037 1.405-.094.25-.142.511-.142.774v7.245l.084 1.441c.348 3.277 2.047 6.142 4.682 8.139.045.036.094.07.143.105l.03.023c1.411 1.03 2.989 1.728 4.694 2.072.786.158 1.591.24 2.389.24.739.0 1.481-.067 2.209-.204.088-.029.176-.045.264-.06.023.0.049-.015.074-.029 1.633-.36 3.148-1.036 4.508-2.025l.029-.031.135-.105c2.627-1.995 4.324-4.862 4.686-8.148L24 10.678V3.445c0-.251-.031-.5-.121-.742l.017.01z"/></svg></span></a></div></div><div class=breadcrumb><a href=../../>&#x1F3E0;HOME</a> > <a href=../../memo/>まくまく設計ノート</a></div></div></article><script>const SIDEBAR_HIDE_THRESHOLD=800,SIDEBAR_WIDTH=250,OFFSET=10;let w=window.innerWidth;w>=SIDEBAR_HIDE_THRESHOLD&&(w-=SIDEBAR_WIDTH),w-=OFFSET,w>=728?rakuten_size="728x200":w>=600?rakuten_size="600x200":w>=468?rakuten_size="468x160":w>=336?rakuten_size="336x280":w>=300?rakuten_size="300x250":w>=250?rakuten_size="250x250":rakuten_size="200x350",rakuten_design="slide",rakuten_affiliateId="1239b074.74af6526.1239b075.bc72ef6e",rakuten_items="ctsmatch",rakuten_genreId=0,rakuten_target="_blank",rakuten_theme="gray",rakuten_border="off",rakuten_auto_mode="on",rakuten_genre_title="off",rakuten_recommend="on",rakuten_txtColor="333333",rakuten_moverColor="30C030",rakuten_bgColor="FFFFFF",rakuten_captionColor="333333"</script><script src=https://xml.affiliate.rakuten.co.jp/widget/js/rakuten_widget.js></script></div><div class=l-withSidebar__sidebarRight><nav class=navigation><div class=navigation__header>カテゴリ一覧</div><ul><li><a class="navigation__item navigation__item--focused" href=https://maku77.github.io/memo/>いろいろ</a><li><a class=navigation__item href=https://maku77.github.io/android/>Android</a><li><a class=navigation__item href=https://maku.blog/p/8t6hr3d/>Ansible</a><li><a class=navigation__item href=https://maku77.github.io/blender/>Blender</a><li><a class=navigation__item href=https://maku77.github.io/cpp/>C/C++</a><li><a class=navigation__item href=https://maku77.github.io/docker/>Docker</a><li><a class=navigation__item href=https://maku77.github.io/git/>Git</a><li><a class=navigation__item href=https://maku77.github.io/go/>Go言語</a><li><a class=navigation__item href=https://maku77.github.io/gradle/>Gradle</a><li><a class=navigation__item href=https://maku77.github.io/web/>HTML/CSS</a><li><a class=navigation__item href=https://maku77.github.io/hugo/>Hugo</a><li><a class=navigation__item href=https://maku77.github.io/java/>Java</a><li><a class=navigation__item href=https://maku77.github.io/js/>JavaScript</a><li><a class=navigation__item href=https://maku77.github.io/kotlin/>Kotlin</a><li><a class=navigation__item href=https://maku77.github.io/linux/>Linux/Shell</a><li><a class=navigation__item href=https://maku.blog/p/somcgdw/>Mac</a><li><a class=navigation__item href=https://maku77.github.io/middleman/>Middleman</a><li><a class=navigation__item href=https://toushi.maku.blog/p/etedykx/>MetaTrader</a><li><a class=navigation__item href=https://maku77.github.io/nodejs/>Node.js</a><li><a class=navigation__item href=https://maku77.github.io/octave/>Octave</a><li><a class=navigation__item href=https://maku77.github.io/p4/>Perforce</a><li><a class=navigation__item href=https://maku77.github.io/perl/>Perl</a><li><a class=navigation__item href=https://maku77.github.io/php/>PHP</a><li><a class=navigation__item href=https://maku77.github.io/python/>Python</a><li><a class=navigation__item href=https://maku77.github.io/r/>R</a><li><a class=navigation__item href=https://maku77.github.io/ruby/>Ruby</a><li><a class=navigation__item href=https://maku77.github.io/rust/>Rust</a><li><a class=navigation__item href=https://maku77.github.io/sass/>Sass</a><li><a class=navigation__item href=https://maku77.github.io/sed/>sed/awk</a><li><a class=navigation__item href=https://maku77.github.io/sql/>SQL</a><li><a class=navigation__item href=https://maku77.github.io/tradestation/>トレードステーション</a><li><a class=navigation__item href=https://maku77.github.io/vagrant/>Vagrant</a><li><a class=navigation__item href=https://maku77.github.io/vba/>VBA</a><li><a class=navigation__item href=https://maku77.github.io/vim/>Vim</a><li><a class=navigation__item href=https://maku77.github.io/windows/>Windows</a></ul></nav><style>.codoc-support{display:inline-block;margin:0!important;padding:12px!important;width:200px!important;max-width:100%}.codoc-support .codoc-support-title{font-size:smaller!important;white-space:nowrap;margin-bottom:12px!important}.codoc-support .codoc-btn{width:160px!important}</style><script src=https://codoc.jp/js/cms.js data-css=black data-usercode=tp6ZPzTj3w defer></script><div id=codoc-entry-4gYwTntzzw class=codoc-entries data-without-body=1 data-support-button-text="（っ'-')╮シュッ🔴" data-show-like=0 data-show-about-codoc=0 data-show-powered-by=0 data-support-message=まくに投げ銭できます。></div></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.querySelectorAll("a[href^=http]");for(let n=0;n<e.length;++n){const t=e[n];if(t.href.startsWith("https://maku77.github.io"))continue;const s=t.getElementsByTagName("img");if(s.length>0)continue;const o=t.getElementsByTagName("svg");if(o.length>0)continue;t.classList.add("xExternalLinkIcon"),t.setAttribute("target","_blank"),t.setAttribute("rel","noopener")}})</script></body></html>